<!DOCTYPE html>
<html dir="rtl" lang="ar">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>نظام التقييم القرآني المتطور</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.1/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.1/firebase-firestore-compat.js"></script>
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet"/>
<link href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css" rel="stylesheet"/>
<style>
    @import url('https://fonts.googleapis.com/css2?family=Tajawal:wght@300;400;500;600;700;800&display=swap');
    @import url('https://fonts.googleapis.com/css2?family=Amiri:wght@400;700&display=swap');
    @import url('https://fonts.googleapis.com/css2?family=Lateef:wght@400;600;700&display=swap');
    @import url('https://fonts.googleapis.com/css2?family=Noto+Naskh+Arabic:wght@400;500;600;700&display=swap');
    
    :root {
      --primary: #1a5f5a;
      --primary-dark: #0d4a45;
      --primary-light: #2d8c85;
      --accent: #3498db;
      --accent-dark: #2980b9;
      --gold: #d4af37;
      --gold-light: #f1e5ac;
      --dark: #2c3e50;
      --light: #ecf0f1;
      --white: #ffffff;
      --gray: #95a5a6;
      --success: #27ae60;
      --warning: #f39c12;
      --danger: #e74c3c;
      --shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
      --radius: 12px;
      --gap: 1.5rem;
      --transition: all 0.3s ease;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      margin: 0;
      font-family: 'Tajawal', sans-serif;
      min-height: 100vh;
      background: linear-gradient(135deg, #f8f9fa, #e9ecef);
      color: var(--dark);
      position: relative;
      overflow-x: hidden;
      line-height: 1.6;
    }

    .app {
      display: flex;
      min-height: 100vh;
      max-width: 1800px;
      margin: 0 auto;
      box-shadow: var(--shadow);
    }

    .sidebar {
      width: 320px; /* زيادة العرض */
      flex-shrink: 0;
      background: linear-gradient(to bottom, var(--primary-dark), var(--primary));
      box-shadow: 5px 0 20px rgba(0, 0, 0, 0.2);
      position: relative;
      overflow: hidden;
      z-index: 10;
    }
    
    .sidebar::before {
      content: '';
      position: absolute;
      top: 0;
      right: 0;
      width: 100%;
      height: 100%;
      background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" width="200" height="200" viewBox="0 0 200 200"><text x="50%" y="50%" font-family="Amiri" font-size="24" fill="rgba(255,255,255,0.05)" text-anchor="middle" dominant-baseline="middle">﷽</text></svg>');
      opacity: 0.1;
      pointer-events: none;
    }

    .sidebar-header {
      padding: var(--gap);
      background: rgba(0, 0, 0, 0.2);
      text-align: center;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }

    .sidebar h1 {
      color: var(--white);
      font-size: 1.8rem;
      margin: 0;
      font-weight: 700;
      position: relative;
      padding-bottom: 10px;
    }

    .search-box {
      padding: 15px;
      background: rgba(0, 0, 0, 0.15);
    }

    .search-box input {
      width: 100%;
      padding: 10px 15px;
      border-radius: 30px;
      border: none;
      background: rgba(255, 255, 255, 0.15);
      color: var(--white);
      font-family: 'Tajawal', sans-serif;
      font-size: 1rem;
      transition: var(--transition);
    }

    .search-box input:focus {
      outline: none;
      background: rgba(255, 255, 255, 0.25);
      box-shadow: 0 0 0 2px var(--gold);
    }

    .search-box input::placeholder {
      color: rgba(255, 255, 255, 0.6);
    }

    .student-list {
      list-style: none;
      margin: 0;
      padding: 0;
      overflow-y: auto;
      max-height: calc(100vh - 200px);
    }

    .student-list li {
      padding: 1.2rem 1.5rem;
      cursor: pointer;
      transition: var(--transition);
      border-bottom: 1px solid rgba(255, 255, 255, 0.05);
      color: var(--white);
      font-weight: 500;
      display: flex;
      align-items: center;
      position: relative;
    }

    .student-list li:hover {
      background: rgba(255, 255, 255, 0.1);
      padding-right: 2rem;
    }

    .student-list li i {
      margin-left: 10px;
      color: var(--gold);
      font-size: 1.2rem;
    }

    .student-list li.active {
      background: linear-gradient(to right, rgba(26, 95, 90, 0.8), var(--primary-dark));
      color: var(--gold-light);
      font-weight: 600;
      box-shadow: inset 5px 0 0 var(--gold);
      padding-right: 2rem;
    }

    .student-list li.active::after {
      content: '';
      position: absolute;
      top: 0;
      right: 0;
      width: 100%;
      height: 100%;
      background: linear-gradient(to right, transparent, rgba(255, 255, 255, 0.1));
      pointer-events: none;
    }

    .main {
      flex: 1;
      padding: var(--gap);
      background: var(--white);
      overflow-y: auto;
      position: relative;
    }

    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: var(--gap);
      padding-bottom: 15px;
      border-bottom: 1px solid rgba(0, 0, 0, 0.1);
    }

    .header h3 {
      color: var(--primary-dark);
      font-size: 1.8rem;
      font-weight: 700;
      margin: 0;
    }

    .header-info {
      display: flex;
      align-items: center;
      gap: 15px;
    }

    .date-box {
      background: var(--light);
      padding: 8px 15px;
      border-radius: 30px;
      font-size: 0.9rem;
      color: var(--dark);
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .user-box {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: var(--primary);
      color: var(--white);
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      font-size: 1.2rem;
    }

    .user-info {
      display: flex;
      flex-direction: column;
    }

    .user-name {
      font-weight: 600;
      color: var(--dark);
    }

    .user-role {
      font-size: 0.8rem;
      color: var(--gray);
    }

    .dashboard {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: var(--gap);
      margin-bottom: var(--gap);
    }

    .card {
      background: var(--white);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 1.5rem;
      transition: var(--transition);
      border: 1px solid rgba(0, 0, 0, 0.05);
      position: relative;
      overflow: hidden;
    }

    .card:hover {
      transform: translateY(-5px);
      box-shadow: 0 15px 30px rgba(0, 0, 0, 0.15);
    }

    .card::before {
      content: '';
      position: absolute;
      top: 0;
      right: 0;
      width: 100%;
      height: 5px;
      background: linear-gradient(to right, var(--primary), var(--accent));
    }

    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1.5rem;
    }

    .card-title {
      font-size: 1.2rem;
      font-weight: 700;
      color: var(--primary-dark);
    }

    .card-icon {
      width: 50px;
      height: 50px;
      border-radius: 12px;
      background: rgba(26, 95, 90, 0.1);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.5rem;
      color: var(--primary);
    }

    .form-section {
      background: var(--white);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: var(--gap);
      margin-bottom: var(--gap);
      position: relative;
      overflow: hidden;
    }

    .form-section::before {
      content: '';
      position: absolute;
      top: 0;
      right: 0;
      width: 100%;
      height: 5px;
      background: linear-gradient(to right, var(--accent), var(--accent-dark));
    }

    .form-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: var(--gap);
      margin-bottom: var(--gap);
    }

    .form-group {
      margin-bottom: 1.2rem;
    }

    .form-group label {
      display: block;
      margin-bottom: 0.5rem;
      font-weight: 600;
      color: var(--dark);
      font-size: 1rem;
    }

    .form-group select,
    .form-group input[type="number"] {
      width: 100%;
      padding: 0.9rem 1rem;
      border: 1px solid rgba(0, 0, 0, 0.1);
      border-radius: 8px;
      background: var(--light);
      font-family: 'Tajawal', sans-serif;
      font-size: 1rem;
      transition: var(--transition);
    }

    .form-group select:focus,
    .form-group input[type="number"]:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.2);
    }

    .checkbox-group {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .checkbox-group input[type="checkbox"] {
      width: 20px;
      height: 20px;
      accent-color: var(--primary);
    }

    .result-container {
      background: linear-gradient(to right, var(--primary), var(--primary-dark));
      border-radius: var(--radius);
      padding: 2rem;
      text-align: center;
      color: var(--white);
      margin: var(--gap) 0;
      position: relative;
      overflow: hidden;
    }

    .result-container::before {
      content: '';
      position: absolute;
      top: -50px;
      right: -50px;
      width: 150px;
      height: 150px;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 50%;
    }

    .result-container::after {
      content: '';
      position: absolute;
      bottom: -30px;
      left: -30px;
      width: 100px;
      height: 100px;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 50%;
    }

    .result-label {
      font-size: 1.2rem;
      margin-bottom: 0.5rem;
      color: var(--gold-light);
    }

    .result-value {
      font-size: 3.5rem;
      font-weight: 800;
      line-height: 1;
      margin: 0.5rem 0;
      color: var(--white);
      text-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
    }

    .result-desc {
      font-size: 1.1rem;
      opacity: 0.9;
      max-width: 500px;
      margin: 0 auto;
    }

    .action-buttons {
      display: flex;
      flex-wrap: wrap;
      gap: 15px;
      justify-content: center;
      margin-top: var(--gap);
    }

    .btn {
      padding: 0.9rem 2rem;
      border-radius: 8px;
      font-family: 'Tajawal', sans-serif;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: var(--transition);
      border: none;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
    }

    .btn-primary {
      background: linear-gradient(to right, var(--primary), var(--primary-dark));
      color: var(--white);
      box-shadow: 0 4px 15px rgba(26, 95, 90, 0.4);
    }

    .btn-primary:hover {
      background: linear-gradient(to right, var(--primary-light), var(--primary));
      transform: translateY(-3px);
      box-shadow: 0 7px 20px rgba(26, 95, 90, 0.6);
    }

    .btn-secondary {
      background: linear-gradient(to right, var(--accent), var(--accent-dark));
      color: var(--white);
      box-shadow: 0 4px 15px rgba(52, 152, 219, 0.4);
    }

    .btn-secondary:hover {
      background: linear-gradient(to right, #3da8e0, var(--accent));
      transform: translateY(-3px);
      box-shadow: 0 7px 20px rgba(52, 152, 219, 0.6);
    }

    .btn-warning {
      background: linear-gradient(to right, var(--gold), #b8860b);
      color: var(--dark);
      box-shadow: 0 4px 15px rgba(212, 175, 55, 0.4);
    }

    .btn-warning:hover {
      background: linear-gradient(to right, #e6c04d, var(--gold));
      transform: translateY(-3px);
      box-shadow: 0 7px 20px rgba(212, 175, 55, 0.6);
    }
    
    .btn-danger {
      background: linear-gradient(to right, var(--danger), #c0392b);
      color: var(--white);
      box-shadow: 0 4px 15px rgba(231, 76, 60, 0.4);
    }
    
    .btn-danger:hover {
      background: linear-gradient(to right, #e74c3c, #e67e22);
      transform: translateY(-3px);
      box-shadow: 0 7px 20px rgba(231, 76, 60, 0.6);
    }

    .stats-section {
      background: var(--white);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: var(--gap);
      margin-bottom: var(--gap);
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: var(--gap);
      margin-top: 1rem;
    }

    .stat-card {
      background: var(--light);
      border-radius: var(--radius);
      padding: 1.5rem;
      display: flex;
      flex-direction: column;
      position: relative;
      overflow: hidden;
      border-left: 4px solid var(--primary);
    }

    .stat-card:nth-child(2) {
      border-left-color: var(--accent);
    }

    .stat-card:nth-child(3) {
      border-left-color: var(--gold);
    }

    .stat-card:nth-child(4) {
      border-left-color: var(--success);
    }

    .stat-card h4 {
      font-size: 1.1rem;
      color: var(--dark);
      margin-bottom: 0.5rem;
    }

    .stat-card .value {
      font-size: 1.8rem;
      font-weight: 700;
      color: var(--primary-dark);
    }

    .stat-card .desc {
      font-size: 0.9rem;
      color: var(--gray);
      margin-top: 0.5rem;
    }

    .ranking-section {
      background: var(--white);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: var(--gap);
    }

    .table-container {
      overflow-x: auto;
      margin-top: 1.5rem;
      border-radius: var(--radius);
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
    }

    table {
      width: 100%;
      border-collapse: separate;
      border-spacing: 0;
      min-width: 800px;
    }

    th {
      background: linear-gradient(to right, var(--primary), var(--primary-dark));
      color: var(--white);
      padding: 1.2rem;
      text-align: center;
      font-weight: 600;
    }

    td {
      padding: 1rem;
      text-align: center;
      border-bottom: 1px solid rgba(0, 0, 0, 0.05);
      background: var(--white);
      transition: var(--transition);
      font-weight: bold !important;
    }

    tr:hover td {
      background: rgba(26, 95, 90, 0.03);
    }

    .first-place {
      background: linear-gradient(to right, rgba(212, 175, 55, 0.05), rgba(212, 175, 55, 0.03));
    }

    .first-place td:first-child {
      font-weight: 800;
      color: var(--gold);
    }

    .second-place {
      background: rgba(192, 192, 192, 0.03);
    }

    .second-place td:first-child {
      color: #c0c0c0;
      font-weight: 700;
    }

    .third-place {
      background: rgba(205, 127, 50, 0.03);
    }

    .third-place td:first-child {
      color: #cd7f32;
      font-weight: 700;
    }

    .export-message {
      position: fixed;
      bottom: 1.5rem;
      left: 50%;
      transform: translateX(-50%);
      background: var(--success);
      color: var(--white);
      padding: 1rem 2rem;
      border-radius: 50px;
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
      z-index: 1000;
      opacity: 0;
      transition: var(--transition);
      font-weight: 600;
    }

    .export-message.show {
      opacity: 1;
      animation: fadeInOut 3s ease-in-out;
    }

    @keyframes fadeInOut {
      0% { opacity: 0; transform: translateX(-50%) translateY(30px); }
      20% { opacity: 1; transform: translateX(-50%) translateY(0)); }
      80% { opacity: 1; transform: translateX(-50%) translateY(0)); }
      100% { opacity: 0; transform: translateX(-50%) translateY(30px); }
    }

    .badge {
      display: inline-block;
      padding: 4px 12px;
      border-radius: 30px;
      font-size: 0.8rem;
      font-weight: 600;
    }

    .badge-success {
      background: rgba(39, 174, 96, 0.15);
      color: var(--success);
    }

    .badge-warning {
      background: rgba(243, 156, 18, 0.15);
      color: var(--warning);
    }

    .badge-danger {
      background: rgba(231, 76, 60, 0.15);
      color: var(--danger);
    }
    
    .progress-container {
      width: 100%;
      height: 15px;
      background-color: #e0e0e0;
      border-radius: 10px;
      margin: 10px 0;
      overflow: hidden;
    }
    
    .progress-bar {
      height: 100%;
      background: linear-gradient(to right, var(--primary), var(--primary-light));
      border-radius: 10px;
      transition: width 0.5s ease;
    }
    
    .penalties-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 1rem;
      background: var(--white);
      border-radius: var(--radius);
      overflow: hidden;
      box-shadow: 0 2px 5px rgba(0,0,0,0.05);
    }
    
    .penalties-table th {
      background: var(--primary-light);
      color: var(--white);
      padding: 0.8rem;
      text-align: right;
    }
    
    .penalties-table td {
      padding: 0.8rem;
      border-bottom: 1px solid rgba(0,0,0,0.05);
      text-align: right;
    }
    
    .penalties-table tr:last-child td {
      border-bottom: none;
    }
    
    .penalties-table tr:nth-child(even) {
      background: rgba(45, 140, 133, 0.05);
    }
    
    .penalties-table .total-row {
      background: rgba(26, 95, 90, 0.1);
      font-weight: bold;
    }
    
    .focus-card {
      background: linear-gradient(to right, #3498db, #2980b9);
      color: white;
      border-radius: var(--radius);
      padding: 1.5rem;
      text-align: center;
    }
    
    .mushaf-card {
      background: linear-gradient(to right, #d4af37, #b8860b);
      color: white;
      border-radius: var(--radius);
      padding: 1.5rem;
      text-align: center;
    }
    
    .focus-card .value, 
    .mushaf-card .value {
      font-size: 2.5rem;
      font-weight: 700;
      margin: 0.5rem 0;
    }
    
    .data-indicator {
      position: absolute;
      top: 12px;
      left: 15px;
      width: 8px;
      height: 8px;
      background-color: var(--gold);
      border-radius: 50%;
    }
    
    .data-indicator.hidden {
      display: none;
    }
    
    .clear-data-btn {
      position: absolute;
      bottom: 15px;
      left: 50%;
      transform: translateX(-50%);
      width: 90%;
      padding: 10px;
      background: rgba(231, 76, 60, 0.15);
      color: var(--danger);
      border: 1px solid rgba(231, 76, 60, 0.3);
      border-radius: 8px;
      text-align: center;
      cursor: pointer;
      transition: var(--transition);
      font-weight: 600;
    }
    
    .clear-data-btn:hover {
      background: rgba(231, 76, 60, 0.25);
      transform: translateX(-50%) translateY(-2px);
    }
    
    .login-container {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: #f3f4f6; color: #1e293b;
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 1000;
    }
    
    .login-box {
      background: white;
      padding: 2rem;
      border-radius: var(--radius);
      width: 90%;
      max-width: 400px;
      text-align: center;
      box-shadow: var(--shadow);
    }
    
    .login-box h2 {
      color: var(--primary);
      margin-bottom: 1.5rem;
    }
    
    .login-input {
      width: 100%;
      padding: 12px;
      margin-bottom: 1rem;
      border: 1px solid #ddd;
      border-radius: 8px;
      font-size: 1rem;
    }
    
    .login-btn {
      background: var(--primary);
      color: white;
      border: none;
      padding: 12px 20px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 1rem;
      width: 100%;
      margin-top: 1rem;
    }
    
    .login-btn:hover {
      background: var(--primary-dark);
    }
    
    .login-message {
      margin-top: 1rem;
      color: var(--danger);
    }
    
    .firebase-status {
      position: fixed;
      bottom: 10px;
      left: 10px;
      background: rgba(0,0,0,0.7);
      color: white;
      padding: 5px 10px;
      border-radius: 5px;
      font-size: 12px;
      z-index: 1000;
    }

    /* واجهة أولياء الأمور الجديدة */
    .parent-container {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: #f0eee5;
      background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="100" height="100" viewBox="0 0 100 100"><path fill="%23d4c8a8" fill-opacity="0.1" d="M20,20 Q40,5 50,30 T80,20 Q95,40 80,60 T50,80 Q40,95 20,80 Q5,60 20,40 Z"/></svg>');
      z-index: 2000;
      display: none;
      flex-direction: column;
      padding: 0;
      overflow-y: auto;
      font-family: 'Lateef', serif;
    }
    
    .parent-header {
      background: linear-gradient(to right, #0d2e1c, #1a472a);
      padding: 25px 0;
      text-align: center;
      position: relative;
      border-bottom: 5px solid #c9a145;
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
      margin-bottom: 30px;
      border-radius: 0;
      width: 100%;
    }
    
    .parent-header::before, .parent-header::after {
      content: "";
      position: absolute;
      bottom: -15px;
      width: 40px;
      height: 40px;
      background: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><path fill="%23c9a145" d="M50,5 L60,40 L95,40 L65,60 L75,95 L50,75 L25,95 L35,60 L5,40 L40,40 Z"/></svg>') center/contain no-repeat;
    }
    
    .parent-header::before {
      left: 10%;
    }
    
    .parent-header::after {
      right: 10%;
    }
    
    .basmala {
      font-family: 'Noto Naskh Arabic', serif;
      font-size: 2.8rem;
      color: #c9a145;
      text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
      letter-spacing: 3px;
      margin-bottom: 15px;
    }
    
    .center-name {
      font-family: 'Lateef', serif;
      font-size: 1.8rem;
      color: white;
      margin-top: -10px;
      margin-bottom: 15px;
    }
    
    .division-name {
      font-size: 2.5rem;
      color: white;
      font-weight: 700;
      position: relative;
      display: inline-block;
    }
    
    .division-name::after {
      content: "";
      position: absolute;
      bottom: -10px;
      left: 50%;
      transform: translateX(-50%);
      width: 120px;
      height: 3px;
      background: #c9a145;
      border-radius: 2px;
    }
    
    .parent-student-select {
      width: 100%;
      padding: 14px;
      margin: 30px auto;
      border: 2px solid #1a472a;
      border-radius: 10px;
      background: white;
      color: #1f2937;
      font-size: 1.2rem;
      font-family: 'Lateef', serif;
      box-shadow: 0 4px 12px rgba(0,0,0,0.05);
      max-width: 500px;
      display: block;
    }
    
    .student-card {
      background: white;
      border-radius: 15px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.08);
      padding: 25px;
      margin: 20px auto;
      border: 1px solid #e0d6bd;
      position: relative;
      overflow: hidden;
      max-width: 1000px;
    }
    
    .student-card::before {
      content: "";
      position: absolute;
      top: 0;
      right: 0;
      width: 100%;
      height: 5px;
      background: linear-gradient(to right, #1a472a, #c9a145);
    }
    
    .student-info {
      display: flex;
      align-items: center;
      gap: 25px;
      margin-bottom: 20px;
    }
    
    .student-avatar {
      width: 120px;
      height: 120px;
      border-radius: 50%;
      border: 3px solid #c9a145;
      padding: 5px;
      background: white;
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .student-avatar i {
      font-size: 3.5rem;
      color: #1a472a;
    }
    
    .student-details h2 {
      font-size: 2.2rem;
      color: #0d2e1c;
      margin-bottom: 5px;
    }
    
    .student-details p {
      font-size: 1.5rem;
      color: #666;
    }
    
    .evaluations {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 25px;
      margin-bottom: 40px;
    }
    
    .evaluation-card {
      background: var(--white);
      border-radius: 15px;
      padding: 25px;
      text-align: center;
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.05);
      border: 1px solid #e9e1d0;
      transition: transform 0.3s ease;
      position: relative;
      overflow: hidden;
    }
    
    .evaluation-card:nth-child(1) {
      background: linear-gradient(135deg, #1a472a, #2c8c5a);
      color: white;
    }
    
    .evaluation-card:nth-child(2) {
      background: linear-gradient(135deg, #1a5f5a, #2d8c85);
      color: white;
    }
    
    .evaluation-card:nth-child(3) {
      background: linear-gradient(135deg, #d4af37, #e6c04d);
      color: #333;
    }
    
    .evaluation-card:nth-child(4) {
      background: linear-gradient(135deg, #0d4a45, #1a5f5a);
      color: white;
    }
    
    .evaluation-card:hover {
      transform: translateY(-10px);
      box-shadow: 0 12px 25px rgba(0, 0, 0, 0.1);
    }
    
    .evaluation-card::before {
      content: "";
      position: absolute;
      top: 0;
      right: 0;
      width: 100%;
      height: 8px;
      background: #1a472a;
    }
    
    .evaluation-icon {
      font-size: 3rem;
      color: white;
      margin-bottom: 15px;
    }
    
    .evaluation-title {
      font-size: 1.8rem;
      margin-bottom: 15px;
      font-weight: 700;
    }
    
    .rating {
      display: flex;
      justify-content: center;
      gap: 5px;
      margin: 20px 0;
    }
    
    .star {
    position: relative;
    font-size: 24px;
    color: #ccc; /* الإطار الرمادي */
  }

    .stars-container {
    display: flex;
    flex-direction: row-reverse; /* لبدء الملء من اليمين */
    gap: 4px;
  }
    
  .star i {
    background: linear-gradient(to left, gold 0%, gold 100%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
  }

  .star.partial i::before {
    content: attr(data-icon);
    position: absolute;
    left: 0;
    top: 0;
    width: var(--fill, 0%);
    overflow: hidden;
    background: linear-gradient(to left, gold 0%, gold 100%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
  }

  .star.partial {
    color: #ccc; /* الرمادي للإطار */
    position: relative;
  }

  .star.partial i {
    color: #ccc;
    position: relative;
    z-index: 1;
  }

  .star.partial i::before {
    z-index: 2;
  }

    .star.filled {
      color: #ffd700;
    }

    .rating-value {
      font-size: 2.2rem;
      font-weight: 700;
      margin-top: 10px;
    }
    
    .progress-container {
      background: rgba(255, 255, 255, 0.3);
      height: 12px;
      border-radius: 10px;
      overflow: hidden;
      margin-top: 15px;
    }
    
    .progress-bar {
      height: 100%;
      background: rgba(255, 255, 255, 0.8);
      border-radius: 10px;
    }
    
    .reports {
      background: white;
      border-radius: 15px;
      padding: 20px;
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.06);
      margin-bottom: 40px;
    }
    
    .section-title {
      font-size: 2.2rem;
      color: #0d2e1c;
      margin-bottom: 25px;
      padding-bottom: 15px;
      border-bottom: 2px solid #c9a145;
      text-align: center;
      position: relative;
    }
    
    .section-title::after {
      content: "✻";
      position: absolute;
      bottom: -15px;
      left: 50%;
      transform: translateX(-50%);
      color: #c9a145;
      font-size: 1.8rem;
    }
    
    .summary-cards {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 25px;
    }
    
    .summary-card {
      background: #f8f3e6;
      border-radius: 12px;
      padding: 20px;
      text-align: center;
      border: 1px solid #e3d9c1;
    }
    
    .summary-card h3 {
      font-size: 1.8rem;
      color: #1a472a;
      margin-bottom: 15px;
    }
    
    .summary-card p {
      font-size: 1.6rem;
      color: #5c4b37;
    }
    
    .teacher-comments {
      background: #f9f7f0;
      border-radius: 12px;
      padding: 25px;
      margin-top: 30px;
      border-left: 4px solid #c9a145;
    }
    
    .teacher-comments h3 {
      font-size: 1.8rem;
      color: #0d2e1c;
      margin-bottom: 15px;
    }
    
    .comments-content {
      font-size: 1.6rem;
      line-height: 1.9;
      color: #5c4b37;
    }
    
    .footer {
      background: linear-gradient(to right, #0d2e1c, #1a472a);
      color: white;
      text-align: center;
      padding: 30px 0;
      margin-top: 40px;
      border-radius: 0;
      position: relative;
      width: 100%;
    }
    
    .footer::before {
      content: "";
      position: absolute;
      top: -15px;
      left: 50%;
      transform: translateX(-50%);
      width: 80%;
      height: 20px;
      background: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 20"><path fill="%23c9a145" d="M0,0 Q25,15 50,0 T100,0 V20 H0 Z"/></svg>') center/cover no-repeat;
    }
    
    .footer p {
      font-size: 1.6rem;
      margin: 10px 0;
    }
    
    .islamic-pattern {
      height: 40px;
      background: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="100" height="40" viewBox="0 0 100 40"><path fill="none" stroke="%23c9a145" stroke-width="1.5" d="M0,20 Q20,0 40,20 T80,20 Q100,40 60,30 T20,20 Q0,30 30,10 T80,20"/></svg>') repeat-x;
      opacity: 0.6;
      margin: 20px 0;
    }

    /* التعديلات الجديدة */
    .group-supervisor {
      display: flex;
      flex-direction: column;
      gap: 10px;
      margin-bottom: 15px;
      padding: 0 15px;
      text-align: center;
      color: white;
    }
    
    .group-supervisor div {
      background: rgba(255, 255, 255, 0.1);
      padding: 10px;
      border-radius: 8px;
      font-weight: bold;
      font-size: 1.1rem;
      position: relative;
    }
    
    .edit-group-btn {
      position: absolute;
      left: 10px;
      top: 50%;
      transform: translateY(-50%);
      background: transparent;
      border: none;
      color: var(--gold);
      cursor: pointer;
      font-size: 14px;
    }
    
    .student-actions {
      display: flex;
      gap: 10px;
      position: absolute;
      top: 10px;
      left: 15px;
    }
    
    .student-actions button {
      background: rgba(255, 255, 255, 0.2);
      border: none;
      border-radius: 50%;
      width: 30px;
      height: 30px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      color: white;
      font-size: 14px;
      transition: var(--transition);
    }
    
    .student-actions button:hover {
      background: rgba(255, 255, 255, 0.3);
      transform: scale(1.1);
    }
    
    .parts-modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.7);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 3000;
    }
    
    .parts-container {
      background: white;
      padding: 20px;
      border-radius: var(--radius);
      max-width: 600px;
      width: 90%;
      max-height: 80vh;
      overflow-y: auto;
    }
    
    .parts-grid {
      display: grid;
      grid-template-columns: repeat(6, 1fr);
      gap: 10px;
      margin-top: 15px;
    }
    
    .part-box {
      aspect-ratio: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      background: #e9e9e9;
      border-radius: 8px;
      cursor: pointer;
      font-weight: bold;
      transition: var(--transition);
    }
    
    .part-box.memorized {
      background: var(--success);
      color: white;
    }
    
    .password-modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.7);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 3000;
    }
    
    .password-container {
      background: white;
      padding: 20px;
      border-radius: var(--radius);
      width: 90%;
      max-width: 400px;
    }
    
    .password-container input {
      width: 100%;
      padding: 10px;
      margin-bottom: 15px;
      border: 1px solid #ddd;
      border-radius: 8px;
      font-family: 'Tajawal', sans-serif;
    }
    
    .notes-modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.7);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 3000;
    }
    
    .notes-container {
      background: white;
      padding: 20px;
      border-radius: var(--radius);
      width: 90%;
      max-width: 500px;
    }
    
    .notes-container textarea {
      width: 100%;
      height: 150px;
      padding: 10px;
      margin-bottom: 15px;
      border: 1px solid #ddd;
      border-radius: 8px;
      font-family: 'Tajawal', sans-serif;
      resize: none;
    }
    
    .curriculum-modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.7);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 3000;
    }
    
    .curriculum-container {
      background: white;
      padding: 20px;
      border-radius: var(--radius);
      width: 90%;
      max-width: 500px;
    }
    
    .curriculum-container textarea {
      width: 100%;
      height: 150px;
      padding: 10px;
      margin-bottom: 15px;
      border: 1px solid #ddd;
      border-radius: 8px;
      font-family: 'Tajawal', sans-serif;
      resize: none;
    }
    
    .curriculum-input {
      width: 100%;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 8px;
      margin-bottom: 15px;
      font-family: 'Tajawal', sans-serif;
    }
    
    .add-remove-buttons {
      display: flex;
      gap: 10px;
      margin-bottom: 10px;
    }
    
    .add-btn, .remove-btn {
      padding: 10px 15px;
      border-radius: 8px;
      font-family: 'Tajawal', sans-serif;
      font-weight: 600;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 5px;
      border: none;
      transition: var(--transition);
    }
    
    .add-btn {
      background: var(--success);
      color: white;
    }
    
    .remove-btn {
      background: var(--danger);
      color: white;
    }
    
    .add-btn:hover, .remove-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 10px rgba(0,0,0,0.1);
    }
    
    .student-ranking-badge {
      background: linear-gradient(135deg, #3498db, #2980b9);
      color: white;
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 0.9rem;
      font-weight: bold;
      margin-top: 10px;
      display: inline-block;
    }
    
    .penalties-table td {
      color: #333; /* لون الخط داكن للوضوح */
      overflow-x: auto

    }
    
    .parent-penalties-wrapper {
  width: 100%;
  overflow-x: auto;
  margin: 20px auto;
}

/* تنسيق الجدول */
.parent-penalties-table {
  width: 100%;
  min-width: 600px; /* يحفظ التنسيق في الشاشات الصغيرة */
  border-collapse: collapse;
  margin: 0 auto;
}

/* رؤوس الأعمدة */
.parent-penalties-table th {
  background: #1a472a;
  color: white;
  padding: 12px;
  text-align: center;
  font-size: 1.2rem;
  white-space: nowrap;
}

/* الخلايا */
.parent-penalties-table td {
  color: #333;
  text-align: center;
  padding: 12px;
  border-bottom: 1px solid #ddd;
  font-size: 1.1rem;
  white-space: nowrap;
}

/* صفوف متبادلة اللون */
.parent-penalties-table tr:nth-child(even) {
  background: rgba(26, 71, 42, 0.05);
}

/* صف الإجمالي */
.parent-penalties-table .total-row {
  background: rgba(26, 95, 90, 0.1);
  font-weight: bold;
}  
    /* التعديلات الجديدة */
    .toggle-arrow {
      margin-right: 8px;
      transition: transform 0.3s ease;
      cursor: pointer;
    }
    
    .toggle-arrow.collapsed {
      transform: rotate(-90deg);
    }
    
    .section-header {
      display: flex;
      align-items: center;
      margin-bottom: 10px;
    }
    
    .save-static-btn {
      background: linear-gradient(to right, #9b59b6, #8e44ad);
      color: white;
      padding: 0.8rem 1.5rem;
      border-radius: 8px;
      font-family: 'Tajawal', sans-serif;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: var(--transition);
      border: none;
      display: flex;
      align-items: center;
      gap: 10px;
      margin-top: 15px;
    }
    
    .save-static-btn:hover {
      background: linear-gradient(to right, #8e44ad, #9b59b6);
      transform: translateY(-2px);
      box-shadow: 0 4px 10px rgba(155, 89, 182, 0.4);
    }
    
    .collapsed-section .form-grid {
      display: none;
    }
    
    .collapsed-section .add-remove-buttons {
      margin-bottom: 0;
    }

    @media (max-width: 992px) {
      .app {
        flex-direction: column;
      }
      .sidebar {
        width: 100%;
        height: auto;
      }
      .student-list {
        max-height: 300px;
      }
      .header {
        flex-direction: column;
        align-items: flex-start;
        gap: 15px;
      }
      .header-info {
        width: 100%;
        justify-content: space-between;
      }
      .clear-data-btn {
        position: relative;
        bottom: auto;
        left: auto;
        transform: none;
        width: 100%;
        margin-top: 15px;
      }
    }

    @media (max-width: 768px) {
      .dashboard {
        grid-template-columns: 1fr;
      }
      .result-value {
        font-size: 2.5rem;
      }
      .action-buttons {
        flex-direction: column;
      }
      .btn {
        width: 100%;
      }
      .student-info {
        flex-direction: column;
        text-align: center;
      }
      .evaluations {
        grid-template-columns: 1fr;
      }
      .summary-cards {
        grid-template-columns: 1fr;
      }
      .parts-grid {
        grid-template-columns: repeat(4, 1fr);
      }
      .basmala {
        font-size: 2.2rem;
      }
      .division-name {
        font-size: 1.8rem;
      }
      .center-name {
        font-size: 1.4rem;
      }
    }

    @media (max-width: 480px) {
      body {
        font-size: 14px;
      }
      .header h3 {
        font-size: 1.2rem;
      }
      .form-group label {
        font-size: 0.9rem;
      }
      .btn {
        font-size: 0.9rem;
        padding: 0.8rem 1.5rem;
      }
      .card .value {
        font-size: 2rem;
      }
      .parts-grid {
        grid-template-columns: repeat(3, 1fr);
      }
    }
    .basmala {
  position: absolute;
  top: 30px;
  left: 50%;
  transform: translateX(-50%);
  font-size: 2rem;
  color: #a88618;
  text-shadow: -1px 2px 15px rgba(0, 0, 0, 0.16);
  font-family: 'Amiri', serif;
  z-index: 1;
  opacity: 1;
}
.centername {
  position: absolute;
  top: 110px;
  left: 50%;
  transform: translateX(-50%);
  font-size: 1.2rem;
  color: #a88618;
  text-shadow: -1px 2px 15px rgba(0, 0, 0, 0.16);
  font-family: 'Amiri', serif;
  z-index: 1;
  opacity: 1;
}

</style>
</head>
<body>
<!-- واجهة تسجيل الدخول للمعلم -->
<div class="login-container" id="loginContainer">
  <div class="login-box">
    <h2>تسجيل الدخول إلى النظام</h2>
    <input class="login-input" id="emailInput" placeholder="البريد الإلكتروني" type="email"/>
    <input class="login-input" id="passwordInput" placeholder="كلمة المرور" type="password"/>
    <button class="login-btn" id="loginBtn">تسجيل الدخول</button>
    <div class="login-message" id="loginMessage"></div>
    <button class="btn btn-secondary" id="showParentView" style="margin-top: 15px; width: 100%;">
      <i class="fas fa-eye"></i> عرض واجهة أولياء الأمور
    </button>
  </div>
</div>

<!-- واجهة المشرف الرئيسية -->
<div class="app" id="appContainer" style="display:none">
  <aside class="sidebar">
    <div class="sidebar-header">
      <img style="width: 100%; border: 2px solid var(--gold); background-color:#ffffff; border-radius: 20px; padding: 10px;" src="./حكما logo.png" alt="">
      <h1>نظام التقييم القرآني</h1>
    </div>
    
    <div class="group-supervisor">
      <div id="groupNameDisplay">شعبة: رجال مؤمنون <button class="edit-group-btn" id="editGroupBtn"><i class="fas fa-edit"></i></button></div>
      <div id="supervisorNameDisplay">المشرف: الشيخ محمد بن عبدالله <button class="edit-group-btn" id="editSupervisorBtn"><i class="fas fa-edit"></i></button></div>
    </div>
    
    <div class="search-box">
      <div class="add-student-btn" style="padding: 10px; text-align: center;">
        <button class="btn btn-secondary" id="addStudentBtn" style="width: 100%; margin-bottom: 10px;">
          <i class="fas fa-user-plus"></i> إضافة طالب
        </button>
        <div id="studentPrompt" style="display:none; padding-top: 10px;">
          <input class="login-input" id="newStudentName" placeholder="اسم الطالب الجديد" style="margin-bottom: 1rem;" type="text"/>
          <button class="btn btn-primary" id="confirmAddStudent">تأكيد الإضافة</button>
        </div>
      </div>
      <input placeholder="ابحث عن طالب..." type="text"/>
    </div>
    
    <ul class="student-list" id="studentList"></ul>
    
    <div class="clear-data-btn" id="clearDataBtn">
      <i class="fas fa-trash-alt"></i> مسح جميع البيانات
    </div>
  </aside>
  
  <main class="main">
    <div class="header">
      <h3 id="currentName">لوحة تحكم المشرف</h3>
      <div class="header-info">
        <div class="date-box">
          <i class="fas fa-calendar"></i>
          <span id="currentDate">اليوم: الأربعاء 28 مايو 2025</span>
        </div>
        <div class="user-box">
          <div class="avatar" id="userAvatar">م</div>
          <div class="user-info">
            <div class="user-name" id="userName"></div>
            <div class="user-role" id="userRole">مشرف الشعبة</div>
          </div>
          <button class="btn btn-danger" id="logoutBtn" style="padding: 8px 15px;">
            <i class="fas fa-sign-out-alt"></i> خروج
          </button>
        </div>
      </div>
    </div>
    
    <div class="dashboard">
      <div class="card">
        <div class="card-header">
          <div class="card-title">إجمالي الطلاب</div>
          <div class="card-icon">
            <i class="fas fa-users"></i>
          </div>
        </div>
        <div class="card-content">
          <div class="value" id="totalStudents">5</div>
          <div class="desc">طلاب مسجلين في النظام</div>
        </div>
      </div>
      <div class="card">
        <div class="card-header">
          <div class="card-title">أعلى تقييم</div>
          <div class="card-icon">
            <i class="fas fa-trophy"></i>
          </div>
        </div>
        <div class="card-content">
          <div class="value" id="highestScore">00%</div>
          <div class="desc" id="highestStudent">اسم الطالب</div>
        </div>
      </div>
      <div class="card">
        <div class="card-header">
          <div class="card-title">متوسط التقييم</div>
          <div class="card-icon">
            <i class="fas fa-chart-line"></i>
          </div>
        </div>
        <div class="card-content">
          <div class="value" id="averageScore">00%</div>
          <div class="desc">متوسط أداء المجموعة</div>
        </div>
      </div>
    </div>
    
    <section class="form-section">
      <h3>تقييم الطالب</h3>
      
      <!-- الأجزاء المراجعة الكاملة -->
      <div class="form-group">
        <div class="section-header">
          <span class="toggle-arrow"><i class="fas fa-chevron-down"></i></span>
          <label>الأجزاء المراجعة الكاملة:</label>
        </div>
        <div class="add-remove-buttons">
          <button class="add-btn" id="addFullBtn">
            <i class="fas fa-plus"></i> إضافة جزء كامل
          </button>
          <button class="remove-btn" id="removeFullBtn">
            <i class="fas fa-minus"></i> حذف جزء كامل
          </button>
        </div>
        <div id="fullContainer"></div>
      </div>
      
      <!-- الأجزاء الجزئية -->
      <div class="form-group">
        <div class="section-header">
          <span class="toggle-arrow"><i class="fas fa-chevron-down"></i></span>
          <label>الأجزاء الجزئية:</label>
        </div>
        <div class="add-remove-buttons">
          <button class="add-btn" id="addSubBtn">
            <i class="fas fa-plus"></i> إضافة جزء جزئي
          </button>
          <button class="remove-btn" id="removeSubBtn">
            <i class="fas fa-minus"></i> حذف جزء جزئي
          </button>
        </div>
        <div id="subContainer"></div>
      </div>
      
      <!-- التسميع الجديد -->
      <div class="form-group">
        <div class="section-header">
          <span class="toggle-arrow"><i class="fas fa-chevron-down"></i></span>
          <label>التسميع الجديد:</label>
        </div>
        <div class="add-remove-buttons">
          <button class="add-btn" id="addNewBtn">
            <i class="fas fa-plus"></i> إضافة تسميع جديد
          </button>
          <button class="remove-btn" id="removeNewBtn">
            <i class="fas fa-minus"></i> حذف تسميع جديد
          </button>
        </div>
        <div id="newContainer"></div>
      </div>
      
      <!-- جزء الواجب -->
      <div class="form-group">
        <div class="section-header">
          <span class="toggle-arrow"><i class="fas fa-chevron-down"></i></span>
          <label>جزء الواجب:</label>
        </div>
        <div class="add-remove-buttons">
          <button class="add-btn" id="addHwBtn">
            <i class="fas fa-plus"></i> إضافة واجب
          </button>
          <button class="remove-btn" id="removeHwBtn">
            <i class="fas fa-minus"></i> حذف واجب
          </button>
        </div>
        <div id="hwContainer"></div>
      </div>
      
      <div class="form-grid">
        <div class="form-group">
          <label>نقاط الأدب (10):</label>
          <select id="adab"></select>
        </div>
        <div class="form-group">
          <label>نقاط الحضور (10):</label>
          <select id="time"></select>
        </div>
        <div class="form-group">
          <label>التركيز (3):</label>
          <select id="focus"></select>
        </div>
        <div class="form-group">
          <label style="margin-bottom: 1.2rem;">أحضر المصحف (2):</label>
          <div class="checkbox-group">
            <input id="mushaf" type="checkbox"/>
            <label for="mushaf">نعم، أحضر المصحف</label>
          </div>
        </div>
      </div>
      
      <div class="result-container animate__animated animate__fadeInDown" style="background: rgba(36, 58, 54, 0.85); border: 1px solid #2f4f4f; border-radius: 16px; box-shadow: 0 0 10px #3a766d; color: #f7f1cf;">
        <div class="result-label">التقييم النهائي</div>
        <div class="result-value" id="result">- %</div>
        <div class="result-desc">هذا التقييم يعكس أداء الطالب بناءً على المعايير المحددة</div>
        <div class="progress-container">
          <div class="progress-bar" id="progressBar" style="width: 0%"></div>
        </div>
      </div>
      
      <div class="action-buttons">
        <button class="btn btn-primary" id="calculate">
          <i class="fas fa-calculator"></i> احسب التقييم
        </button>
        <button class="btn btn-secondary" id="showRanking">
          <i class="fas fa-trophy"></i> عرض الترتيب
        </button>
        <button class="btn btn-warning" id="exportExcel">
          <i class="fas fa-file-excel"></i> تصدير إكسل
        </button>
        <button class="btn btn-secondary" id="exportPDF">
          <i class="fas fa-file-pdf"></i> تصدير تقرير PDF
        </button>
        <button class="btn btn-danger" id="clearCurrentData">
          <i class="fas fa-eraser"></i> مسح بيانات الطالب الحالي
        </button>
        <button class="save-static-btn" id="saveStaticData">
          <i class="fas fa-save"></i> حفظ البيانات الثابتة
        </button>
      </div>
    </section>
    
    <section class="stats-section" id="statsSection">
      <h3>تفاصيل التقييم</h3>
      <div class="stats-grid" id="statsList"></div>
    </section>
    
    <div class="detail-section" id="penaltiesSection">
      <h4>تفاصيل الخصومات</h4>
      <table class="penalties-table animate__animated animate__fadeIn" style="background:rgba(0,0,0,0.25);color:#f0f0f0;border-radius:12px;">
        <thead>
          <tr>
            <th>النوع</th>
            <th>الجزء</th>
            <th>الصفحات</th>
            <th>الأخطاء</th>
            <th>الترددات</th>
            <th>الخصم</th>
          </tr>
        </thead>
        <tbody id="penaltiesBody"></tbody>
      </table>
    </div>
    
    <section class="ranking-section" id="rankingSection">
      <h3>ترتيب الطلاب</h3>
      <div class="table-container">
        <table>
          <thead>
            <tr>
              <th>المركز</th>
              <th>الاسم</th>
              <th>الأجزاء الكاملة</th>
              <th>نقاط الأدب</th>
              <th>نقاط الحضور</th>
              <th>النسبة (%)</th>
              <th>الحالة</th>
            </tr>
          </thead>
          <tbody id="rankingBody"></tbody>
        </table>
      </div>
    </section>
  </main>
</div>

<!-- واجهة أولياء الأمور الجديدة -->
<div class="parent-container" id="parentContainer">
  <div class="parent-header">
  <div class="basmala">﷽</div> 
  <div class="basmal">      ّ</div> 
  <div class="basmal">      ّ</div>
  <div class="basmal">      ّ</div>
  <div class="basmal">      ّ</div>
  <div class="basmal">      ّ</div> 

    <div class="centername">بوابة ولي الأمر - مشروع همم</div>
  </div>
  
  <!-- شاشة تسجيل الدخول لأولياء الأمور -->
  <div id="parentLogin" style="display: none; max-width: 500px; margin: 0 auto; padding: 20px; background:#ffffff; border-radius: 15px; box-shadow: 0 5px 15px #a88618(0, 0, 0, 0.1);">
    <h3 style="text-align: center; margin-bottom: 20px; color: #1a5f5a;">تسجيل الدخول لأولياء الأمور</h3>
    <input type="text" class="login-input" id="parentStudentName" placeholder="اسم الطالب الثلاثي">
    <input type="password" class="login-input" id="parentPassword" placeholder="كلمة المرور">
    <button class="login-btn" id="parentLoginBtn" style="margin-top: 15px;">تسجيل الدخول</button>
    <div id="parentLoginMessage" style="color: var(--danger); text-align: center; margin-top: 15px;"></div>
  </div>
  
  <!-- محتوى واجهة أولياء الأمور بعد تسجيل الدخول -->
  <div id="parentContent" style="display: none;">
    <div id="parentStudentInfo"></div>
    
    <footer class="footer">
      <div class="container">
        <div class="islamic-pattern"></div>
        <p>نظام متابعة تقييم القرآن الكريم - مركز حكما القرآني</p>
        <p>نسعى لبناء جيل حافظ لكتاب الله، متخلق بأخلاق القرآن</p>
        <p>© 1445هـ - جميع الحقوق محفوظة</p>
      </div>
    </footer>
  </div>
</div>

<!-- نماذج إضافية -->
<div class="parts-modal" id="partsModal">
  <div class="parts-container">
    <h3 id="partsTitle">تحديد الأجزاء المحفوظة</h3>
    <div class="parts-grid" id="partsGrid"></div>
    <div class="action-buttons" style="margin-top: 20px;">
      <button class="btn btn-primary" id="savePartsBtn">حفظ</button>
      <button class="btn btn-danger" id="closePartsBtn">إغلاق</button>
    </div>
  </div>
</div>

<div class="password-modal" id="passwordModal">
  <div class="password-container">
    <h3 id="passwordTitle">تعيين كلمة مرور الطالب</h3>
    <input type="password" id="studentPasswordInput" placeholder="كلمة المرور الجديدة">
    <input type="password" id="studentPasswordConfirm" placeholder="تأكيد كلمة المرور">
    <div class="action-buttons">
      <button class="btn btn-primary" id="savePasswordBtn">حفظ</button>
      <button class="btn btn-danger" id="closePasswordBtn">إغلاق</button>
    </div>
  </div>
</div>

<div class="notes-modal" id="notesModal">
  <div class="notes-container">
    <h3 id="notesTitle">ملاحظات المشرف</h3>
    <textarea id="teacherNotes" placeholder="اكتب ملاحظات المشرف هنا..."></textarea>
    <div class="action-buttons">
      <button class="btn btn-primary" id="saveNotesBtn">حفظ</button>
      <button class="btn btn-danger" id="closeNotesBtn">إغلاق</button>
    </div>
  </div>
</div>

<div class="curriculum-modal" id="curriculumModal">
  <div class="curriculum-container">
    <h3 id="curriculumTitle">المقرر المطلوب</h3>
    <textarea id="studentCurriculum" placeholder="اكتب المقرر المطلوب للطالب..."></textarea>
    <div class="action-buttons">
      <button class="btn btn-primary" id="saveCurriculumBtn">حفظ</button>
      <button class="btn btn-danger" id="closeCurriculumBtn">إغلاق</button>
    </div>
  </div>
</div>

<div class="export-message" id="exportMessage">تم تصدير البيانات بنجاح</div>
<div class="firebase-status" id="firebaseStatus">جارٍ الاتصال بـ Firebase...</div>

<script>
    document.addEventListener('DOMContentLoaded', () => {
      // بيانات الصعوبة
      const diff = {
        1: 1.8, 2: 1.5, 3: 1.5, 4: 1.5, 5: 1, 6: 1.5, 7: 1,
        8: 1, 9: 1, 10: 1.5, 11: 1, 12: 1.5, 13: 1.5,
        14: 0.8, 15: 2, 16: 1.8, 17: 1.5, 18: 1.5, 19: 1.5,
        20: 1, 21: 1.5, 22: 1.5, 23: 1, 24: 1.8, 25: 1,
        26: 1, 27: 1.8, 28: 1, 29: 1.8, 30: 2
      };

      // قائمة الطلاب
      const students = [
        "إلياس أحمد",
        "أوس مصطفى",
        "علاء الرياحنة",
        "المتيم بالله أحمد",
        "يوسف عبد القادر",
      ];

      // إعداد التاريخ
      const now = new Date();
      const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
      document.getElementById('currentDate').textContent = now.toLocaleDateString('ar-AR', options);
      
      const MAX_PARTS = 30;
      let studentData = {};
      let current = null;
      let firebaseInitialized = false;
      let db = null;
      let auth = null;
      let currentUser = null;
      let memorizedParts = {};
      let teacherNotes = {};
      let studentCurriculum = {};
      let studentPasswords = {};
      let groupName = "رجال مؤمنون";
      let supervisorName = "الشيخ محمد بن عبدالله";

      // عناصر واجهة المستخدم
      const timeSel = document.getElementById('time');
      const ul = document.getElementById('studentList');
      const exportMessage = document.getElementById('exportMessage');
      const loginContainer = document.getElementById('loginContainer');
      const appContainer = document.getElementById('appContainer');
      const firebaseStatus = document.getElementById('firebaseStatus');
      const parentContainer = document.getElementById('parentContainer');
      const parentLogin = document.getElementById('parentLogin');
      const parentContent = document.getElementById('parentContent');
      const parentDivisionName = document.getElementById('parentDivisionName');
      
      // تهيئة Firebase
      function initializeFirebase() {
        try {
          const firebaseConfig = {
            apiKey: "AIzaSyBDbGNmqeMNRz_q45worAx42zPoNPFGlQ4",
            authDomain: "hemmah-8a5a8.firebaseapp.com",
            projectId: "hemmah-8a5a8",
            storageBucket: "hemmah-8a5a8.appspot.com",
            messagingSenderId: "832515158602",
            appId: "1:832515158602:web:54fae9fccd4b61e655ecb3",
            measurementId: "G-LZVS47NZGN"
          };

          firebase.initializeApp(firebaseConfig);
          auth = firebase.auth();
          db = firebase.firestore();

          firebaseStatus.textContent = "تم الاتصال بـ Firebase بنجاح";
          firebaseStatus.style.background = "rgba(39, 174, 96, 0.7)";
          
          // متابعة حالة المصادقة
          auth.onAuthStateChanged(user => {
            if (user) {
              // تم تسجيل الدخول
              currentUser = user;
              loginContainer.style.display = 'none';
              appContainer.style.display = 'flex';
              
              // تحديث معلومات المستخدم
              document.getElementById('userName').textContent = user.displayName || user.email;
              document.getElementById('userAvatar').textContent = user.displayName ? user.displayName.charAt(0) : user.email.charAt(0);
              
              // تحميل بيانات الطلاب
              loadStudentList();
              loadGroupInfo();
            } else {
              // لم يتم تسجيل الدخول
              loginContainer.style.display = 'flex';
              appContainer.style.display = 'none';
            }
          });
          
          firebaseInitialized = true;
        } catch (error) {
          firebaseStatus.textContent = "خطأ في الاتصال بـ Firebase: " + error.message;
          firebaseStatus.style.background = "rgba(231, 76, 60, 0.7)";
          console.error("Firebase initialization error:", error);
        }
      }
      
      // تسجيل الدخول
      document.getElementById('loginBtn').addEventListener('click', async () => {
        const email = document.getElementById('emailInput').value;
        const password = document.getElementById('passwordInput').value;
        const loginMessage = document.getElementById('loginMessage');
        
        if (!email || !password) {
          loginMessage.textContent = "الرجاء إدخال البريد الإلكتروني وكلمة المرور";
          return;
        }
        
        try {
          await auth.signInWithEmailAndPassword(email, password);
          loginMessage.textContent = "";
        } catch (error) {
          loginMessage.textContent = "خطأ في تسجيل الدخول: " + error.message;
        }
      });
      
      // تسجيل الخروج
      document.getElementById('logoutBtn').addEventListener('click', () => {
        auth.signOut();
      });
      
      // عرض واجهة أولياء الأمور
      document.getElementById('showParentView').addEventListener('click', () => {
        loginContainer.style.display = 'none';
        parentContainer.style.display = 'flex';
        parentLogin.style.display = 'block';
        parentContent.style.display = 'none';
        parentDivisionName.textContent = `شعبة: ${groupName}`;
      });
      
      // تحميل معلومات الشعبة والمشرف
      async function loadGroupInfo() {
        if (!currentUser) return;
        
        try {
          const doc = await db.collection('teachers').doc(currentUser.uid).collection('groupInfo').doc('info').get();
          if (doc.exists) {
            groupName = doc.data().groupName || groupName;
            supervisorName = doc.data().supervisorName || supervisorName;
          }
          
          document.getElementById('groupNameDisplay').textContent = `شعبة: ${groupName}`;
          document.getElementById('supervisorNameDisplay').textContent = `المشرف: ${supervisorName}`;
          
          // إضافة زر التعديل
          const groupDiv = document.getElementById('groupNameDisplay');
          const supervisorDiv = document.getElementById('supervisorNameDisplay');
          
          groupDiv.innerHTML = `شعبة: ${groupName} <button class="edit-group-btn" id="editGroupBtn"><i class="fas fa-edit"></i></button>`;
          supervisorDiv.innerHTML = `المشرف: ${supervisorName} <button class="edit-group-btn" id="editSupervisorBtn"><i class="fas fa-edit"></i></button>`;
          
          document.getElementById('editGroupBtn').addEventListener('click', editGroupName);
          document.getElementById('editSupervisorBtn').addEventListener('click', editSupervisorName);
          
        } catch (error) {
          console.error("Error loading group info:", error);
        }
      }
      
      // تعديل اسم الشعبة
      function editGroupName() {
        const newName = prompt("اسم الشعبة الجديد:", groupName);
        if (newName && newName.trim() !== "") {
          groupName = newName.trim();
          document.getElementById('groupNameDisplay').textContent = `شعبة: ${groupName}`;
          saveGroupInfo();
        }
      }
      
      // تعديل اسم المشرف
      function editSupervisorName() {
        const newName = prompt("اسم المشرف الجديد:", supervisorName);
        if (newName && newName.trim() !== "") {
          supervisorName = newName.trim();
          document.getElementById('supervisorNameDisplay').textContent = `المشرف: ${supervisorName}`;
          saveGroupInfo();
        }
      }
      
      // حفظ معلومات الشعبة
      async function saveGroupInfo() {
        if (!currentUser) return;
        
        try {
          await db.collection('teachers').doc(currentUser.uid).collection('groupInfo').doc('info').set({
            groupName: groupName,
            supervisorName: supervisorName,
            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
          });
          
          // حفظ نسخة للقراءة فقط لأولياء الأمور
          await db.collection('teachers').doc('public').collection('groupInfo').doc('info').set({
            groupName: groupName,
            supervisorName: supervisorName,
            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
          });
          
          firebaseStatus.textContent = "تم حفظ معلومات الشعبة بنجاح";
          firebaseStatus.style.background = "rgba(39, 174, 96, 0.7)";
        } catch (error) {
          firebaseStatus.textContent = "خطأ في حفظ معلومات الشعبة: " + error.message;
          firebaseStatus.style.background = "rgba(231, 76, 60, 0.7)";
        }
      }
      
      // تسجيل دخول أولياء الأمور
      document.getElementById('parentLoginBtn').addEventListener('click', async () => {
        const studentName = document.getElementById('parentStudentName').value.trim();
        const password = document.getElementById('parentPassword').value;
        const message = document.getElementById('parentLoginMessage');
        
        if (!studentName || !password) {
          message.textContent = "الرجاء إدخال اسم الطالب وكلمة المرور";
          return;
        }
        
        try {
          // التحقق من كلمة المرور
          const doc = await db.collection('teachers').doc('public').collection('studentStaticData').doc(studentName).get();
          if (doc.exists && doc.data().password === password) {
            parentLogin.style.display = 'none';
            parentContent.style.display = 'block';
            renderParentStudentInfo(studentName);
          } else {
            message.textContent = "اسم الطالب أو كلمة المرور غير صحيحة";
          }
        } catch (error) {
          message.textContent = "حدث خطأ: " + error.message;
        }
      });
      
      // عرض معلومات الطالب لأولياء الأمور
      async function renderParentStudentInfo(studentName) {
        const container = document.getElementById('parentStudentInfo');
        container.innerHTML = '';
        
        // جلب بيانات الطالب
        let studentData = {};
try {
  const doc = await db.collection('teachers').doc('public').collection('students').doc(studentName).get();
  if (doc.exists) {
    studentData = doc.data();

    // ✅ تقريب قيمة total بعد تحميل البيانات
    if (studentData.total) {
      studentData.total = parseFloat(studentData.total.toFixed(2));
    }
  }
} catch (error) {
  console.error("Error loading student data:", error);
}

if (!studentData.total) {
  container.innerHTML = '<p style="text-align: center; font-size: 1.5rem; margin: 2rem;">لا توجد بيانات تقييم لهذا الطالب بعد</p>';
  return;
}

        
        // حساب ترتيب الطالب
        let studentRanking = 0;
        try {
          const snapshot = await db.collection('teachers').doc('public').collection('students').get();
          const students = [];
          snapshot.forEach(doc => {
            if (doc.data().total) {
              students.push({ name: doc.id, total: doc.data().total });
            }
          });
          
          students.sort((a, b) => b.total - a.total);
          studentRanking = students.findIndex(s => s.name === studentName) + 1;
        } catch (error) {
          console.error("Error calculating ranking:", error);
        }
        
        // إنشاء بطاقة معلومات الطالب
        const studentCard = document.createElement('div');
        studentCard.className = 'student-card';
        studentCard.innerHTML = `
          <div class="student-info">
            <div class="student-avatar">
              <i class="fas fa-user-graduate"></i>
            </div>
            <div class="student-details">
              <h2>${studentName}</h2>
        
              <p>آخر تحديث: ${new Date().toLocaleDateString('ar-AR')}</p>
              <div class="student-ranking-badge">المركز: ${studentRanking}</div>
            </div>
          </div>
        `;
        container.appendChild(studentCard);
        
        // إنشاء تقييمات الطالب
        const evaluations = document.createElement('div');
        evaluations.className = 'evaluations';
        
        // حساب نقاط الأداء والمصحف (من 5 نقاط)
        const performanceScore = (studentData.focus || 0) + (studentData.mushaf ? 2 : 0);
        
        const evaluationCards = [
  { 
    icon: 'fas fa-book-quran',
    title: 'نقاط الحفظ',
    value: studentData.hifdh ? parseFloat(studentData.hifdh.toFixed(1)) : 0,
    max: 75,
    description: `الأجزاء المسمعة: ${studentData.totalEquivalentParts ? formatPercentage(studentData.totalEquivalentParts) : '0.00'}`
  },
  { 
    icon: 'fas fa-microphone-lines',
    title: 'نقاط الأداء والمصحف',
    value: parseFloat(performanceScore.toFixed(2)),
    max: 5,
    description: 'التركيز والأداء وإحضار المصحف'
  },
  { 
    icon: 'fas fa-calendar-check',
    title: 'نقاط الحضور',
    value: parseFloat((studentData.delay || 0).toFixed(2)),
    max: 10,
    description: `دقائق التأخير: ${studentData.lateMinutes || 0}`
  },
  { 
    icon: 'fas fa-hands-praying',
    title: 'نقاط الأدب',
    value: parseFloat((studentData.adab || 0).toFixed(2)),
    max: 10,
    description: 'سلوك الطالب في الملتقى'
  }
];


        function formatPercentage(value) {
        if (typeof value !== 'number') return '0.00';
        return value.toFixed(2);
      }
        
        evaluationCards.forEach(card => {
          const cardEl = document.createElement('div');
          cardEl.className = 'evaluation-card';
          
          // حساب النجوم (5 نجوم) مع إمكانية نصف نجمة
          const stars = Math.round((card.value / card.max) * 10);
          let starsHtml = '';
          for (let i = 1; i <= 10; i++) {
            starsHtml += `<span class="star ${i <= stars ? 'filled' : ''}"><i class="${i <= stars ? 'fas' : 'far'} fa-star"></i></span>`;
          }
 
      cardEl.innerHTML = `
            <div class="evaluation-icon">
              <i class="${card.icon}"></i>
            </div>
            <h3 class="evaluation-title">${card.title}</h3>
            <div class="rating">
              ${starsHtml}
            </div>
            <div class="rating-value">${card.value}/${card.max}</div>
            <p>${card.description}</p>
            <div class="progress-container">
              <div class="progress-bar" style="width: ${(card.value / card.max) * 100}%"></div>
            </div>
          `;
          evaluations.appendChild(cardEl);
        });
        
        container.appendChild(evaluations);
        
        // إنشاء تقارير المشرف
        const reports = document.createElement('div');
        reports.className = 'reports';
        reports.innerHTML = `
          <h2 class="section-title">ملخص الأداء وتقارير المشرف</h2>
          
          <div class="summary-cards">
            <div class="summary-card">
              <h3>التقييم النهائي</h3>
              <p>${studentData.total >= 90 ? 'ممتاز' : studentData.total >= 75 ? 'جيد جدًا' : studentData.total >= 60 ? 'يحتاج تحسين' : 'إنذار'} (${studentData.total}%)</p>
            </div>
            <div class="summary-card">
              <h3>مقرر الملتقى القادم</h3>
              <p>${studentCurriculum[studentName] || studentData.nextGoal || ''}</p>
            </div>
          </div>
          
          <div class="teacher-comments">
            <h3>ملاحظات المشرف</h3>
            <p class="comments-content">
              ${teacherNotes[studentName] || studentData.comments || ''}
            </p>
          </div>
        `;
        container.appendChild(reports);
        
        // عرض جدول تفاصيل الخصومات
        const penaltiesSection = document.createElement('div');
        penaltiesSection.className = 'reports';
        penaltiesSection.innerHTML = `
          <h2 class="section-title">تفاصيل الخصومات</h2>
          <table class="parent-penalties-table">
            <thead>
              <tr>
                <th>النوع</th>
                <th>الجزء</th>
                <th>الصفحات</th>
                <th>الأخطاء</th>
                <th>الترددات</th>
                <th>الخصم</th>
              </tr>
            </thead>
            <tbody id="parentPenaltiesBody"></tbody>
          </table>
        `;
        container.appendChild(penaltiesSection);
        
        // تعبئة جدول الخصومات
        const penaltiesBody = document.getElementById('parentPenaltiesBody');
        if (studentData.penDetails && studentData.penDetails.length > 0) {
          studentData.penDetails.forEach(item => {
            const row = document.createElement('tr');
            row.innerHTML = `
              <td>${item.type}</td>
              <td>${item.part}</td>
              <td>${item.pages || 'كامل'}</td>
              <td>${item.errors}</td>
              <td>${item.reps}</td>
              <td>${formatPercentage(item.totalPenalty)}</td>
            `;
            penaltiesBody.appendChild(row);
          });
          
          // إضافة الصف الإجمالي
          const totalRow = document.createElement('tr');
          totalRow.className = 'total-row';
          totalRow.innerHTML = `
            <td colspan="5" style="font-weight: bold; text-align: center;">إجمالي الخصومات</td>
            <td style="font-weight: bold; text-align: center;">${formatPercentage(studentData.penDetails.reduce((sum, item) => sum + item.totalPenalty, 0))}</td>
          `;
          penaltiesBody.appendChild(totalRow);
        } else {
          const row = document.createElement('tr');
          row.innerHTML = `
            <td colspan="6" style="text-align: center; padding: 1.5rem;">لا توجد خصومات مسجلة</td>
          `;
          penaltiesBody.appendChild(row);
        }
      }
      
      // وظائف المساعدة
      function fillSelect(el, from, to) {
        for (let i = from; i <= to; i++) {
          let o = document.createElement('option');
          o.value = i;
          o.textContent = i;
          el.appendChild(o);
        }
      }
      
      // تقريب النسب المئوية إلى 4 خانات
      function formatPercentage(value) {
        if (typeof value !== 'number') return '0.00';
        return value.toFixed(2);
      }

      // ملء القوائم المنسدلة
      fillSelect(document.getElementById('adab'), 0, 10);
      fillSelect(document.getElementById('focus'), 1, 3);

      // إعداد خيارات الوقت
      const startTime = new Date();
      startTime.setHours(5, 30, 0); // الساعة 5:30
      
      const endTime = new Date();
      endTime.setHours(8, 30, 0); // الساعة 8:30
      
      let currentTime = new Date(startTime);
      
      while (currentTime <= endTime) {
        const hours = currentTime.getHours();
        const minutes = currentTime.getMinutes();
        const timeString = `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}`;
        
        const option = document.createElement('option');
        option.value = timeString;
        option.textContent = timeString;
        timeSel.appendChild(option);
        
        // زيادة الوقت بمقدار 5 دقائق
        currentTime.setMinutes(currentTime.getMinutes() + 5);
      }

      // إنشاء صف في الحاوية
      function createRow(cnt, type) {
        let row = document.createElement('div');
        row.className = 'form-grid';
        if (['sub', 'new', 'hw'].includes(type)) {
          let ip = document.createElement('input');
          ip.type = 'number';
          ip.placeholder = 'عدد الصفحات';
          ip.min = 0;
          ip.className = 'form-control';
          row.appendChild(ip);
        }
        let sel = document.createElement('select');
        for (let p = 1; p <= MAX_PARTS; p++) {
          let o = document.createElement('option');
          o.value = p;
          o.textContent = p;
          sel.appendChild(o);
        }
        row.appendChild(sel);
        ['أخطاء', 'ترددات'].forEach(ph => {
          let inp = document.createElement('input');
          inp.type = 'number';
          inp.placeholder = ph;
          inp.min = 0;
          inp.className = 'form-control';
          row.appendChild(inp);
        });
        cnt.appendChild(row);
      }

      // إضافة وحذف الأجزاء
      document.getElementById('addFullBtn').addEventListener('click', () => {
        createRow(document.getElementById('fullContainer'), 'full');
      });
      
      document.getElementById('removeFullBtn').addEventListener('click', () => {
        const container = document.getElementById('fullContainer');
        if (container.children.length > 0) {
          container.removeChild(container.lastChild);
        }
      });
      
      document.getElementById('addSubBtn').addEventListener('click', () => {
        createRow(document.getElementById('subContainer'), 'sub');
      });
      
      document.getElementById('removeSubBtn').addEventListener('click', () => {
        const container = document.getElementById('subContainer');
        if (container.children.length > 0) {
          container.removeChild(container.lastChild);
        }
      });
      
      document.getElementById('addNewBtn').addEventListener('click', () => {
        createRow(document.getElementById('newContainer'), 'new');
      });
      
      document.getElementById('removeNewBtn').addEventListener('click', () => {
        const container = document.getElementById('newContainer');
        if (container.children.length > 0) {
          container.removeChild(container.lastChild);
        }
      });
      
      document.getElementById('addHwBtn').addEventListener('click', () => {
        createRow(document.getElementById('hwContainer'), 'hw');
      });
      
      document.getElementById('removeHwBtn').addEventListener('click', () => {
        const container = document.getElementById('hwContainer');
        if (container.children.length > 0) {
          container.removeChild(container.lastChild);
        }
      });

      // إنشاء قائمة الطلاب مع مؤشر البيانات
      function createStudentList() {
        ul.innerHTML = '';
        students.forEach(name => {
          let li = document.createElement('li');
          li.innerHTML = `<i class="fas fa-user-graduate"></i> ${name}`;
          
          // مؤشر البيانات المحفوظة
          const indicator = document.createElement('div');
          indicator.className = 'data-indicator';
          indicator.classList.toggle('hidden', !studentData[name] || !studentData[name].total);
          li.appendChild(indicator);
          
          // أزرار الإجراءات
          const actions = document.createElement('div');
          actions.className = 'student-actions';
          
          const passwordBtn = document.createElement('button');
          passwordBtn.innerHTML = '<i class="fas fa-key"></i>';
          passwordBtn.title = 'تعيين كلمة مرور';
          passwordBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            showPasswordModal(name);
          });
          
          const partsBtn = document.createElement('button');
          partsBtn.innerHTML = '<i class="fas fa-book"></i>';
          partsBtn.title = 'تحديد الأجزاء المحفوظة';
          partsBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            showPartsModal(name);
          });
          
          const notesBtn = document.createElement('button');
          notesBtn.innerHTML = '<i class="fas fa-edit"></i>';
          notesBtn.title = 'إضافة ملاحظات';
          notesBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            showNotesModal(name);
          });
          
          const curriculumBtn = document.createElement('button');
          curriculumBtn.innerHTML = '<i class="fas fa-book-open"></i>';
          curriculumBtn.title = 'تعيين المقرر';
          curriculumBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            showCurriculumModal(name);
          });
          
          actions.appendChild(passwordBtn);
          actions.appendChild(partsBtn);
          actions.appendChild(notesBtn);
          actions.appendChild(curriculumBtn);
          li.appendChild(actions);
          
          li.addEventListener('click', () => selectStudent(name, li));
          ul.appendChild(li);
        });
      }

      // عرض نموذج كلمة المرور
      function showPasswordModal(studentName) {
        const modal = document.getElementById('passwordModal');
        const title = document.getElementById('passwordTitle');
        
        title.textContent = `تعيين كلمة مرور للطالب: ${studentName}`;
        document.getElementById('studentPasswordInput').value = studentPasswords[studentName] || '';
        document.getElementById('studentPasswordConfirm').value = studentPasswords[studentName] || '';
        
        // حفظ كلمة المرور
        document.getElementById('savePasswordBtn').onclick = async () => {
          const password = document.getElementById('studentPasswordInput').value;
          const confirmPassword = document.getElementById('studentPasswordConfirm').value;
          
          if (password !== confirmPassword) {
            alert('كلمة المرور وتأكيدها غير متطابقين');
            return;
          }
          
          studentPasswords[studentName] = password;
          
          // حفظ في Firebase
          try {
            await db.collection('teachers').doc(currentUser.uid).collection('studentStaticData').doc(studentName).set({
              password: password,
              updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            }, { merge: true });
            
            // حفظ نسخة للقراءة فقط لأولياء الأمور
            await db.collection('teachers').doc('public').collection('studentStaticData').doc(studentName).set({
              password: password,
              updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            }, { merge: true });
            
            modal.style.display = 'none';
            firebaseStatus.textContent = "تم حفظ كلمة المرور بنجاح";
            firebaseStatus.style.background = "rgba(39, 174, 96, 0.7)";
          } catch (error) {
            console.error("Error saving password:", error);
            firebaseStatus.textContent = "خطأ في حفظ كلمة المرور: " + error.message;
            firebaseStatus.style.background = "rgba(231, 76, 60, 0.7)";
          }
        };
        
        // إغلاق النموذج
        document.getElementById('closePasswordBtn').onclick = () => {
          modal.style.display = 'none';
        };
        
        modal.style.display = 'flex';
      }
      
      // عرض نموذج الأجزاء
      function showPartsModal(studentName) {
        const modal = document.getElementById('partsModal');
        const title = document.getElementById('partsTitle');
        const grid = document.getElementById('partsGrid');
        
        title.textContent = `الأجزاء المحفوظة للطالب: ${studentName}`;
        grid.innerHTML = '';
        
        // إنشاء مربعات الأجزاء
        for (let i = 1; i <= 30; i++) {
          const partBox = document.createElement('div');
          partBox.className = 'part-box';
          if (memorizedParts[studentName] && memorizedParts[studentName].includes(i)) {
            partBox.classList.add('memorized');
          }
          partBox.textContent = i;
          partBox.addEventListener('click', () => {
            partBox.classList.toggle('memorized');
          });
          grid.appendChild(partBox);
        }
        
        // حفظ الأجزاء
        document.getElementById('savePartsBtn').onclick = async () => {
          const memorized = [];
          grid.querySelectorAll('.part-box.memorized').forEach(box => {
            memorized.push(parseInt(box.textContent));
          });
          memorizedParts[studentName] = memorized;
          
          // حفظ في Firebase
          try {
            await db.collection('teachers').doc(currentUser.uid).collection('studentStaticData').doc(studentName).set({
              memorizedParts: memorized,
              updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            }, { merge: true });
            
            // حفظ نسخة للقراءة فقط لأولياء الأمور
            await db.collection('teachers').doc('public').collection('studentStaticData').doc(studentName).set({
              memorizedParts: memorized,
              updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            }, { merge: true });
            
            modal.style.display = 'none';
            firebaseStatus.textContent = "تم حفظ الأجزاء المحفوظة بنجاح";
            firebaseStatus.style.background = "rgba(39, 174, 96, 0.7)";
          } catch (error) {
            console.error("Error saving parts:", error);
            firebaseStatus.textContent = "خطأ في حفظ الأجزاء المحفوظة: " + error.message;
            firebaseStatus.style.background = "rgba(231, 76, 60, 0.7)";
          }
        };
        
        // إغلاق النموذج
        document.getElementById('closePartsBtn').onclick = () => {
          modal.style.display = 'none';
        };
        
        modal.style.display = 'flex';
      }
      
      // عرض نموذج الملاحظات
      function showNotesModal(studentName) {
        const modal = document.getElementById('notesModal');
        const title = document.getElementById('notesTitle');
        const textarea = document.getElementById('teacherNotes');
        
        title.textContent = `ملاحظات المشرف للطالب: ${studentName}`;
        textarea.value = teacherNotes[studentName] || '';
        
        // حفظ الملاحظات
        document.getElementById('saveNotesBtn').onclick = async () => {
          teacherNotes[studentName] = textarea.value;
          
          // حفظ في Firebase
          try {
            await db.collection('teachers').doc(currentUser.uid).collection('studentStaticData').doc(studentName).set({
              notes: textarea.value,
              updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            }, { merge: true });
            
            // حفظ نسخة للقراءة فقط لأولياء الأمور
            await db.collection('teachers').doc('public').collection('studentStaticData').doc(studentName).set({
              notes: textarea.value,
              updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            }, { merge: true });
            
            modal.style.display = 'none';
            firebaseStatus.textContent = "تم حفظ الملاحظات بنجاح";
            firebaseStatus.style.background = "rgba(39, 174, 96, 0.7)";
          } catch (error) {
            console.error("Error saving notes:", error);
            firebaseStatus.textContent = "خطأ في حفظ الملاحظات: " + error.message;
            firebaseStatus.style.background = "rgba(231, 76, 60, 0.7)";
          }
        };
        
        // إغلاق النموذج
        document.getElementById('closeNotesBtn').onclick = () => {
          modal.style.display = 'none';
        };
        
        modal.style.display = 'flex';
      }
      
      // عرض نموذج المقرر
      function showCurriculumModal(studentName) {
        const modal = document.getElementById('curriculumModal');
        const title = document.getElementById('curriculumTitle');
        const textarea = document.getElementById('studentCurriculum');
        
        title.textContent = `المقرر المطلوب للطالب: ${studentName}`;
        textarea.value = studentCurriculum[studentName] || '';
        
        // حفظ المقرر
        document.getElementById('saveCurriculumBtn').onclick = async () => {
          studentCurriculum[studentName] = textarea.value;
          
          // حفظ في Firebase
          try {
            await db.collection('teachers').doc(currentUser.uid).collection('studentStaticData').doc(studentName).set({
              curriculum: textarea.value,
              updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            }, { merge: true });
            
            // حفظ نسخة للقراءة فقط لأولياء الأمور
            await db.collection('teachers').doc('public').collection('studentStaticData').doc(studentName).set({
              curriculum: textarea.value,
              updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            }, { merge: true });
            
            modal.style.display = 'none';
            firebaseStatus.textContent = "تم حفظ المقرر بنجاح";
            firebaseStatus.style.background = "rgba(39, 174, 96, 0.7)";
          } catch (error) {
            console.error("Error saving curriculum:", error);
            firebaseStatus.textContent = "خطأ في حفظ المقرر: " + error.message;
            firebaseStatus.style.background = "rgba(231, 76, 60, 0.7)";
          }
        };
        
        // إغلاق النموذج
        document.getElementById('closeCurriculumBtn').onclick = () => {
          modal.style.display = 'none';
        };
        
        modal.style.display = 'flex';
      }

      // تحديد طالب
      function selectStudent(name, li) {
        current = name;
        document.querySelectorAll('.student-list li').forEach(x => 
          x.classList.remove('active'));
        li.classList.add('active');
        document.getElementById('currentName').textContent = `تقييم الطالب: ${name}`;
        let d = studentData[name] || {};
        ['adab', 'time', 'focus'].forEach(id => {
          if (d[id] != null) document.getElementById(id).value = d[id];
        });
        document.getElementById('mushaf').checked = d.mushaf || false;
        
        // تعبئة حقول الأجزاء
        ['fullContainer', 'subContainer', 'newContainer', 'hwContainer'].forEach(containerId => {
          const container = document.getElementById(containerId);
          container.innerHTML = '';
          
          if (d[containerId] && Array.isArray(d[containerId])) {
            d[containerId].forEach(() => {
              createRow(container, containerId.replace('Container', ''));
            });
          }
        });
        
        document.getElementById('statsSection').style.display = 'block';
        document.getElementById('rankingSection').style.display = 'block';
        document.getElementById('penaltiesSection').style.display = 'block';
        
        // تحديث تفاصيل الطالب إذا كان لديه بيانات
        if (d.total != null) {
          document.getElementById('result').textContent = formatPercentage(d.total) + '%';
          document.getElementById('progressBar').style.width = d.total + '%';
          renderStats(d);
          renderPenalties(d);
        }
        
        // تعبئة حقول الأخطاء والتكرارات بعد إنشاء الحقول
        setTimeout(() => {
          ['fullContainer', 'subContainer', 'newContainer', 'hwContainer'].forEach(containerId => {
            const container = document.getElementById(containerId);
            if (container && d[containerId] && Array.isArray(d[containerId])) {
              const rows = container.querySelectorAll('.form-grid');
              rows.forEach((row, index) => {
                const itemData = d[containerId][index];
                if (itemData) {
                  const inputs = row.querySelectorAll('input, select');
                  let inputIndex = 0;
                  
                  // تعبئة حقول الصفحات (إن وجدت)
                  if (containerId !== 'fullContainer') {
                    inputs[inputIndex].value = itemData.pages || '';
                    inputIndex++;
                  }
                  
                  // تعبئة حقول الجزء والأخطاء والتكرارات
                  inputs[inputIndex++].value = itemData.part;
                  inputs[inputIndex++].value = itemData.errors || 0;
                  inputs[inputIndex++].value = itemData.reps || 0;
                }
              });
            }
          });
        }, 100);
      }

      // تحديث لوحة التحكم
      function updateDashboard() {
        const studentsWithScores = Object.entries(studentData)
          .filter(([, data]) => data.total != null)
          .map(([name, data]) => ({ name, total: data.total }));
        
        if (studentsWithScores.length > 0) {
          // حساب أعلى تقييم
          const highest = studentsWithScores.reduce((max, student) => 
            student.total > max.total ? student : max, studentsWithScores[0]);
          
          document.getElementById('highestScore').textContent = formatPercentage(highest.total) + '%';
          document.getElementById('highestStudent').textContent = highest.name;
          
          // حساب متوسط التقييم
          const totalScore = studentsWithScores.reduce((sum, student) => sum + student.total, 0);
          const average = totalScore / studentsWithScores.length;
          document.getElementById('averageScore').textContent = formatPercentage(average) + '%';
        }
        
        document.getElementById('totalStudents').textContent = students.length;
      }

      // عرض الإحصائيات
      function renderStats(d) {
        const stats = document.getElementById('statsList');
        stats.innerHTML = '';
        
        const statCards = [
          { 
            title: 'الأجزاء المعادلة', 
            value: formatPercentage(d.totalEquivalentParts),
            desc: 'إجمالي الأجزاء المحفوظة معادلة'
          },
          { 
            title: 'نقاط الأدب', 
            value: d.adab || 0,
            desc: 'من أصل 10 نقاط'
          },
          { 
            title: 'نقاط الحضور', 
            value: formatPercentage(d.delay) || 0,
            desc: 'من أصل 10 نقاط'
          },
          { 
            title: 'نقاط التركيز والمصحف', 
            value: (d.focus || 0) + (d.mushaf ? 2 : 0),
            desc: 'من أصل 5 نقاط'
          },
          { 
            title: 'نقاط الحفظ', 
            value: d.hifdh ? formatPercentage(d.hifdh) : 0,
            desc: 'من أصل 75 نقطة'
          }
        ];
        
        statCards.forEach(card => {
          const cardEl = document.createElement('div');
          cardEl.className = 'stat-card';
          cardEl.innerHTML = `
            <h4>${card.title}</h4>
            <div class="value">${card.value}</div>
            <div class="desc">${card.desc}</div>
          `;
          stats.appendChild(cardEl);
        });
      }
      
      // عرض تفاصيل الخصومات مع إضافة عمود الصفحات
      function renderPenalties(d) {
        const penaltiesBody = document.getElementById('penaltiesBody');
        penaltiesBody.innerHTML = '';
        
        let totalPenalty = 0;
        
        if (d.penDetails && d.penDetails.length > 0) {
          d.penDetails.forEach((item, index) => {
            const row = document.createElement('tr');
            row.innerHTML = `
              <td>${item.type}</td>
              <td>${item.part}</td>
              <td>${item.pages || 'كامل'}</td>
              <td>${item.errors}</td>
              <td>${item.reps}</td>
              <td>${formatPercentage(item.totalPenalty)}</td>
            `;
            penaltiesBody.appendChild(row);
            totalPenalty += item.totalPenalty;
          });
          
          // إضافة الصف الإجمالي
          const totalRow = document.createElement('tr');
          totalRow.className = 'total-row';
          totalRow.innerHTML = `
            <td colspan="5" style="font-weight: bold; text-align: center; padding: 8px; border: 1px solid #ddd;">إجمالي الخصومات</td>
            <td style="font-weight: bold; padding: 8px; border: 1px solid #ddd; text-align: center;">${formatPercentage(totalPenalty)}</td>
          `;
          penaltiesBody.appendChild(totalRow);
        } else {
          const row = document.createElement('tr');
          row.innerHTML = `
            <td colspan="6" style="text-align: center; padding: 1.5rem;">لا توجد خصومات مسجلة</td>
          `;
          penaltiesBody.appendChild(row);
        }
      }

      // حساب التقييم
      document.getElementById('calculate').addEventListener('click', async () => {
        if (!current) return alert('الرجاء اختيار طالب أولاً');
        if (!currentUser) return alert('الرجاء تسجيل الدخول أولاً');
        
        let d = {
          mushaf: document.getElementById('mushaf').checked,
          adab: +document.getElementById('adab').value,
          focus: +document.getElementById('focus').value,
          time: document.getElementById('time').value,
          numFull: document.getElementById('fullContainer').children.length,
          numSub: document.getElementById('subContainer').children.length,
          numNew: document.getElementById('newContainer').children.length,
          numHW: document.getElementById('hwContainer').children.length
        };

        const containers = {
          fullContainer: {type: 'مراجعة كامل', pagesPerPart: 1},
          subContainer: {type: 'مراجعة جزئي', pagesPerPart: 20},
          newContainer: {type: 'جديد', pagesPerPart: 5},
          hwContainer: {type: 'واجب', pagesPerPart: 10}
        };

        d.totalEquivalentParts = 0;
        d.penDetails = [];
        const allItems = [];

        // جمع العناصر وحساب الأجزاء المعادلة
        Object.entries(containers).forEach(([cid, info]) => {
          d[cid] = [];
          document.querySelectorAll(`#${cid} .form-grid`).forEach(r => {
            const inputs = r.querySelectorAll('input, select');
            let idx = 0;
            const item = {
              type: info.type,
              pages: inputs.length > 3 ? +inputs[idx++].value : 0,
              part: +inputs[idx++].value,
              errors: +inputs[idx++].value,
              reps: +inputs[idx++].value
            };

            const equivalentParts = item.pages ? item.pages / info.pagesPerPart : 1;
            allItems.push({...item, equivalentParts});
            d.totalEquivalentParts += equivalentParts;
            d[cid].push(item);
          });
        });

        // حساب الخصومات
        allItems.forEach(item => {
          const coeff = diff[item.part] || 0;
          const repsPenalty = (0.2 * item.reps * coeff) / d.totalEquivalentParts;
          const errorsPenalty = (0.8 * item.errors * coeff) / d.totalEquivalentParts;
          const totalPenalty = repsPenalty + errorsPenalty;
          
          d.penDetails.push({
            ...item,
            coeff,
            repsPenalty,
            errorsPenalty,
            totalPenalty
          });
        });

        // حساب نقاط الحفظ
        d.hifdh = Math.max(0, 75 - d.penDetails.reduce((s, p) => s + p.totalPenalty, 0));
        
        // حساب نقاط الحضور
        d.delay = 0;
        
        // حساب نقاط الحضور
        if (d.time) {
          const [hours, minutes] = d.time.split(':').map(Number);
          const studentTime = new Date();
          studentTime.setHours(hours, minutes, 0);
          
          const startTime = new Date();
          startTime.setHours(5, 30, 0); // الساعة 5:30
          
          // حساب عدد الدقائق المتأخرة
          const lateMinutes = Math.max(0, (studentTime - startTime) / (1000 * 60));
          
          // الخصم: 10 * (عدد دقائق التأخير / 180)
          d.lateMinutes = lateMinutes;
          d.delay = Math.max(0, 10 - (10 * (lateMinutes / 180)));
        }
        
        // حساب النقاط الكلية
        d.total = 
          (d.adab || 0) + 
          (d.delay || 0) + 
          (d.focus || 0) + 
          (d.mushaf ? 2 : 0) + 
          (d.hifdh || 0);
        
        studentData[current] = d;
        
        // حفظ البيانات في Firebase
        await saveStudentData(current, d);
        
        // تحديث مؤشر البيانات المحفوظة
        createStudentList();
        document.querySelectorAll('.student-list li').forEach(li => {
          if (li.textContent.includes(current)) {
            li.querySelector('.data-indicator').classList.remove('hidden');
            li.classList.add('active');
          }
        });
        
        document.getElementById('result').textContent = formatPercentage(d.total) + '%';
        document.getElementById('progressBar').style.width = d.total + '%';
        renderStats(d);
        renderPenalties(d);
        updateDashboard();
      });

      // عرض الترتيب
      document.getElementById('showRanking').addEventListener('click', () => {
        const arr = Object.entries(studentData)
          .filter(([, v]) => v.total != null)
          .map(([n, v]) => ({ name: n, total: v.total, adab: v.adab, numFull: v.numFull || 0, delay: v.delay }));
        
        arr.sort((a, b) => b.total - a.total);
        const tbody = document.getElementById('rankingBody');
        tbody.innerHTML = '';
        
        arr.forEach((s, i) => {
          const tr = document.createElement('tr');
          if (i === 0) tr.classList.add('first-place');
          else if (i === 1) tr.classList.add('second-place');
          else if (i === 2) tr.classList.add('third-place');
          
          // وضعية الطالب
          let status = '';
          let badge = '';
          if (s.total >= 90) {
            status = 'ممتاز';
            badge = '<span class="badge badge-success">ممتاز</span>';
          } else if (s.total >= 75) {
            status = 'جيد جدًا';
            badge = '<span class="badge badge-success">جيد جدًا</span>';
          } else if (s.total >= 60) {
            status = 'جيد';
            badge = '<span class="badge badge-warning">جيد</span>';
          } else {
            status = 'يحتاج تحسين';
            badge = '<span class="badge badge-danger">يحتاج تحسين</span>';
          }
          
          tr.innerHTML = `
            <td>${i + 1}</td>
            <td>${s.name}</td>
            <td>${s.numFull}</td>
            <td>${s.adab}</td>
            <td>${s.delay.toFixed(1)}</td>
            <td>${formatPercentage(s.total)}%</td>
            <td>${badge}</td>
          `;
          tbody.appendChild(tr);
        });
      });

      // تصدير إلى إكسل
      document.getElementById('exportExcel').addEventListener('click', () => {
        const students = Object.entries(studentData)
          .filter(([, data]) => data.total)
          .map(([name, data]) => ({
            الاسم: name,
            'الأجزاء الكاملة': data.numFull || 0,
            'نقاط الأدب': data.adab,
            'نقاط الحضور': data.delay.toFixed(2),
            'إجمالي الأجزاء المعادلة': formatPercentage(data.totalEquivalentParts),
            'نقاط الحفظ بعد الخصم': formatPercentage(data.hifdh),
            'التركيز': data.focus,
            'أحضر المصحف': data.mushaf ? 'نعم' : 'لا',
            'إجمالي النسبة': formatPercentage(data.total)
          }));

        const ws = XLSX.utils.json_to_sheet(students);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "الطلاب");
        XLSX.writeFile(wb, "إحصائيات_الطلاب_رجال_مؤمنون.xlsx");
        
        showExportMessage();
      });

      // تصدير إلى PDF مع إضافة عمود الصفحات
      document.getElementById('exportPDF').addEventListener('click', async () => {
        if (!current) return alert('الرجاء اختيار طالب أولاً');
        
        const student = studentData[current];
        if (!student.total) return alert('لا توجد بيانات كافية لإنشاء التقرير');
        
        // إنشاء عنصر مؤقت للتقرير
        const reportContainer = document.createElement('div');
        reportContainer.style.position = 'absolute';
        reportContainer.style.left = '-9999px';
        reportContainer.style.width = '260mm';
        reportContainer.style.padding = '0.1cm 0.1cm';
        reportContainer.style.fontFamily = "'Tajawal', sans-serif";
        reportContainer.style.fontSize = '11pt';
        reportContainer.style.direction = 'rtl';
        reportContainer.style.backgroundColor = 'white';
        
        // محتوى التقرير مع تقليل الهامش العلوي
        reportContainer.innerHTML = `
          <div style="text-align: center; margin-bottom: 10px; padding-top: 5mm;">
            <h1 style="color: #1a5f5a; font-size: 20pt; margin-bottom: 5px;">تقرير أداء الطالب</h1>
            <h2 style="color: #3498db; font-size: 16pt;">شعبة ${groupName}</h2>
          </div>
          
          <table style="width: 100%; border-collapse: collapse; margin-bottom: 15px; font-size: 11pt;">
            <tr>
              <th style="padding: 8px; border: 1px solid #ddd; background-color: #1a5f5a; color: white;">اسم الطالب</th>
              <th style="padding: 8px; border: 1px solid #ddd; background-color: #1a5f5a; color: white;">التاريخ</th>
              <th style="padding: 8px; border: 1px solid #ddd; background-color: #1a5f5a; color: white;">الشعبة</th>
              <th style="padding: 8px; border: 1px solid #ddd; background-color: #1a5f5a; color: white;">المشرف</th>
            </tr>
            <tr>
              <td style="padding: 8px; border: 1px solid #ddd; text-align: center;">${current}</td>
              <td style="padding: 8px; border: 1px solid #ddd; text-align: center;">${new Date().toLocaleDateString('ar-AR')}</td>
              <td style="padding: 8px; border: 1px solid #ddd; text-align: center;">${groupName}</td>
              <td style="padding: 8px; border: 1px solid #ddd; text-align: center;">${supervisorName}</td>
            </tr>
          </table>
          
          <div style="margin-bottom: 15px;">
            <div style="background: #3498db; color: white; padding: 8px; border-radius: 3px; margin-bottom: 10px; font-size: 14pt;">تفاصيل التقييم</div>
            <table style="width: 100%; border-collapse: collapse; margin-bottom: 15px; font-size: 11pt;">
              <tr>
                <th style="padding: 8px; border: 1px solid #ddd; background-color: #1a5f5a; color: white;">المعيار</th>
                <th style="padding: 8px; border: 1px solid #ddd; background-color: #1a5f5a; color: white;">القيمة</th>

              </tr>
              <tr>
                <td style="padding: 8px; border: 1px solid #ddd; text-align: center;">الأجزاء المراجعة الكاملة</td>
                <td style="padding: 8px; border: 1px solid #ddd; text-align: center;">${student.numFull || 0}</td>

              </tr>
              <tr>
                <td style="padding: 8px; border: 1px solid #ddd; text-align: center;">الأجزاء المراجعة الجزئية</td>
                <td style="padding: 8px; border: 1px solid #ddd; text-align: center;">${student.numSub || 0}</td>

              </tr>
              <tr>
                <td style="padding: 8px; border: 1px solid #ddd; text-align: center;">التسميع الجديد</td>
                <td style="padding: 8px; border: 1px solid #ddd; text-align: center;">${student.numNew || 0}</td>

              </tr>
              <tr>
                <td style="padding: 8px; border: 1px solid #ddd; text-align: center;">جزء الواجب</td>
                <td style="padding: 8px; border: 1px solid #ddd; text-align: center;">${student.numHW || 0}</td>

              </tr>
            </table>
          </div>
          
          <div style="margin-bottom: 15px;">
            <div style="background: #d4af37; color: white; padding: 8px; border-radius: 3px; margin-bottom: 10px; font-size: 14pt;">تفاصيل الخصومات</div>
            <table style="width: 100%; border-collapse: collapse; margin-bottom: 15px; font-size: 11pt;">
              <tr>
                <th style="padding: 8px; border: 1px solid #ddd; background-color: #d4af37; color: white;">النوع</th>
                <th style="padding: 8px; border: 1px solid #ddd; background-color: #d4af37; color: white;">الجزء</th>
                <th style="padding: 8px; border: 1px solid #ddd; background-color: #d4af37; color: white;">الصفحات</th>
                <th style="padding: 8px; border: 1px solid #ddd; background-color: #d4af37; color: white;">الأخطاء</th>
                <th style="padding: 8px; border: 1px solid #ddd; background-color: #d4af37; color: white;">الترددات</th>
                <th style="padding: 8px; border: 1px solid #ddd; background-color: #d4af37; color: white;">الخصم</th>
              </tr>
              ${student.penDetails && student.penDetails.length > 0 ? 
                student.penDetails.map(item => `
                  <tr>
                    <td style="padding: 8px; border: 1px solid #ddd; text-align: center;">${item.type}</td>
                    <td style="padding: 8px; border: 1px solid #ddd; text-align: center;">${item.part}</td>
                    <td style="padding: 8px; border: 1px solid #ddd; text-align: center;">${item.pages || 'كامل'}</td>
                    <td style="padding: 8px; border: 1px solid #ddd; text-align: center;">${item.errors}</td>
                    <td style="padding: 8px; border: 1px solid #ddd; text-align: center;">${item.reps}</td>
                    <td style="padding: 8px; border: 1px solid #ddd; text-align: center;">${formatPercentage(item.totalPenalty)}</td>
                  </tr>
                `).join('') : `
                  <tr>
                    <td colspan="6" style="text-align: center; padding: 1.5rem;">لا توجد خصومات مسجلة</td>
                  </tr>
                `}
              <tr style="background: rgba(26, 95, 90, 0.1); font-weight: bold;">
                <td colspan="5" style="font-weight: bold; text-align: center; padding: 8px; border: 1px solid #ddd;">إجمالي الخصومات</td>
                <td style="font-weight: bold; padding: 8px; border: 1px solid #ddd; text-align: center;">${student.penDetails ? formatPercentage(student.penDetails.reduce((sum, item) => sum + item.totalPenalty, 0)) : '0.00'}</td>
              </tr>
            </table>
          </div>
          
          <div style="margin-bottom: 15px;">
            <div style="background: #27ae60; color: white; padding: 8px; border-radius: 3px; margin-bottom: 10px; font-size: 14pt;">ترتيب الطلاب</div>
            <table style="width: 100%; border-collapse: collapse; margin-bottom: 15px; font-size: 11pt;">
              <tr>
                <th style="padding: 8px; border: 1px solid #ddd; background-color: #27ae60; color: white;">المركز</th>
                <th style="padding: 8px; border: 1px solid #ddd; background-color: #27ae60; color: white;">الاسم</th>
                <th style="padding: 8px; border: 1px solid #ddd; background-color: #27ae60; color: white;">النسبة (%)</th>
                <th style="padding: 8px; border: 1px solid #ddd; background-color: #27ae60; color: white;">الحالة</th>
              </tr>
              ${Object.entries(studentData)
                .filter(([, data]) => data.total != null)
                .sort((a, b) => b[1].total - a[1].total)
                .map(([name, data], index) => `
                  <tr ${name === current ? 'style="background-color: #f1e5ac; font-weight: bold;"' : ''}>
                    <td style="padding: 8px; border: 1px solid #ddd; text-align: center;">${index + 1}</td>
                    <td style="padding: 8px; border: 1px solid #ddd; text-align: center;">${name}</td>
                    <td style="padding: 8px; border: 1px solid #ddd; text-align: center;">${formatPercentage(data.total)}%</td>
                    <td style="padding: 8px; border: 1px solid #ddd; text-align: center;">${
                      data.total >= 90 ? 'ممتاز' : 
                      data.total >= 75 ? 'جيد جدًا' : 
                      data.total >= 60 ? 'يحتاج إلى تثبيت' : 'إنذار'
                    }</td>
                  </tr>
                `).join('')}
            </table>
          </div>
          
          <div style="text-align: center; margin-top: 20px; padding: 15px; background: #e9f7f6; border-radius: 5px; font-weight: bold; font-size: 14pt;">
            التقييم النهائي: ${formatPercentage(student.total)}% - 
            ${
              student.total >= 90 ? 'ممتاز' : 
              student.total >= 75 ? 'جيد جدًا' : 
              student.total >= 60 ? 'يحتاج إلى تثبيت' : 'إنذار'
            }
          </div>
        `;
        
        document.body.appendChild(reportContainer);
        
        try {
          // إنشاء PDF باستخدام html2canvas و jsPDF
          const canvas = await html2canvas(reportContainer, {
            scale: 2,
            useCORS: true,
            logging: false
          });
          
          const imgData = canvas.toDataURL('image/jpeg', 0.95);
          const pdf = new jspdf.jsPDF({
            orientation: 'portrait',
            unit: 'mm',
            format: 'a4'
          });
          
          const imgWidth = 210;
          const pageHeight = 297;
          const imgHeight = canvas.height * imgWidth / canvas.width;
          let heightLeft = imgHeight;
          let position = 0;
          
          pdf.addImage(imgData, 'JPEG', 0, position, imgWidth, imgHeight);
          heightLeft -= pageHeight;
          
          while (heightLeft >= 0) {
            position = heightLeft - imgHeight;
            pdf.addPage();
            pdf.addImage(imgData, 'JPEG', 0, position, imgWidth, imgHeight);
            heightLeft -= pageHeight;
          }
          
          pdf.save(`تقرير_${current}_${groupName}.pdf`);
          showExportMessage();
        } catch (error) {
          console.error('خطأ في إنشاء PDF:', error);
          alert('حدث خطأ أثناء إنشاء التقرير. الرجاء المحاولة مرة أخرى.');
        } finally {
          document.body.removeChild(reportContainer);
        }
      });

      // وظيفة لعرض رسالة التصدير
      function showExportMessage() {
        exportMessage.classList.add('show');
        setTimeout(() => {
          exportMessage.classList.remove('show');
        }, 3000);
      }

      // مسح بيانات الطالب الحالي
      document.getElementById('clearCurrentData').addEventListener('click', () => {
        if (!current) return;
        
        if (confirm(`هل أنت متأكد من رغبتك في مسح بيانات الطالب ${current}؟`)) {
          delete studentData[current];
          document.querySelectorAll('.student-list li').forEach(li => {
            if (li.textContent.includes(current)) {
              li.querySelector('.data-indicator').classList.add('hidden');
            }
          });
          
          // إعادة تعيين الحقول
          document.getElementById('adab').value = '';
          document.getElementById('time').value = '';
          document.getElementById('focus').value = '';
          document.getElementById('mushaf').checked = false;
          
          ['fullContainer', 'subContainer', 'newContainer', 'hwContainer'].forEach(id => {
            document.getElementById(id).innerHTML = '';
          });
          
          document.getElementById('result').textContent = '- %';
          document.getElementById('progressBar').style.width = '0%';
          document.getElementById('statsList').innerHTML = '';
          document.getElementById('penaltiesBody').innerHTML = '';
          
          // حذف البيانات من Firebase
          deleteStudentData(current);
        }
      });

      // مسح جميع البيانات
      document.getElementById('clearDataBtn').addEventListener('click', () => {
        if (confirm('هل أنت متأكد من رغبتك في مسح جميع بيانات الطلاب؟')) {
          studentData = {};
          document.querySelectorAll('.student-list li').forEach(li => {
            li.querySelector('.data-indicator').classList.add('hidden');
          });
          
          // إعادة تعيين الحقول
          document.getElementById('adab').value = '';
          document.getElementById('time').value = '';
          document.getElementById('focus').value = '';
          document.getElementById('mushaf').checked = false;
          
          ['fullContainer', 'subContainer', 'newContainer', 'hwContainer'].forEach(id => {
            document.getElementById(id).innerHTML = '';
          });
          
          document.getElementById('result').textContent = '- %';
          document.getElementById('progressBar').style.width = '0%';
          document.getElementById('statsList').innerHTML = '';
          document.getElementById('penaltiesBody').innerHTML = '';
          document.getElementById('rankingBody').innerHTML = '';
          
          // مسح البيانات من Firebase
          clearAllData();
        }
      });

      // حفظ البيانات الثابتة
      document.getElementById('saveStaticData').addEventListener('click', async () => {
        if (!currentUser) return;
        
        try {
          // حفظ البيانات الثابتة في Firebase
          await saveStudentStaticData();
          await saveGroupInfo();
          
          firebaseStatus.textContent = "تم حفظ البيانات الثابتة بنجاح";
          firebaseStatus.style.background = "rgba(39, 174, 96, 0.7)";
        } catch (error) {
          firebaseStatus.textContent = "خطأ في حفظ البيانات الثابتة: " + error.message;
          firebaseStatus.style.background = "rgba(231, 76, 60, 0.7)";
        }
      });
      
      // === وظائف Firebase المعدلة ===

      // حفظ بيانات الطالب في Firebase
      async function saveStudentData(studentName, data) {
        if (!currentUser) return;
        
        try {
          // حفظ بيانات التقييم للمعلم
          const evaluationData = {
            ...data,
            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
          };
          
          await db.collection('teachers').doc(currentUser.uid).collection('students').doc(studentName).set(evaluationData, { merge: true });
          
          // حفظ نسخة للقراءة فقط لأولياء الأمور (بدون معلومات حساسة)
          const publicData = {
            name: studentName,
            total: data.total,
            totalEquivalentParts: data.totalEquivalentParts,
            adab: data.adab,
            delay: data.delay,
            lateMinutes: data.lateMinutes,
            hifdh: data.hifdh,
            focus: data.focus,
            mushaf: data.mushaf,
            penDetails: data.penDetails,
            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
          };
          
          await db.collection('teachers').doc('public').collection('students').doc(studentName).set(publicData, { merge: true });
          
          firebaseStatus.textContent = "تم حفظ بيانات الطالب بنجاح";
          firebaseStatus.style.background = "rgba(39, 174, 96, 0.7)";
        } catch (error) {
          firebaseStatus.textContent = "خطأ في حفظ البيانات: " + error.message;
          firebaseStatus.style.background = "rgba(231, 76, 60, 0.7)";
          console.error("Firebase save error:", error);
        }
      }

      // حفظ البيانات الثابتة للطلاب
      async function saveStudentStaticData() {
        if (!currentUser) return;
        
        try {
          // حفظ البيانات لكل طالب
          for (const studentName of students) {
            const staticData = {
              password: studentPasswords[studentName] || '',
              memorizedParts: memorizedParts[studentName] || [],
              curriculum: studentCurriculum[studentName] || '',
              notes: teacherNotes[studentName] || '',
              updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            };
            
            await db.collection('teachers').doc(currentUser.uid).collection('studentStaticData').doc(studentName).set(staticData);
            
            // حفظ نسخة للقراءة فقط لأولياء الأمور (بدون كلمة المرور)
            const publicStaticData = {
              password: staticData.password,
              memorizedParts: staticData.memorizedParts,
              curriculum: staticData.curriculum,
              notes: staticData.notes,
              updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            };
            
            await db.collection('teachers').doc('public').collection('studentStaticData').doc(studentName).set(publicStaticData);
          }
          
          console.log("تم حفظ البيانات الثابتة بنجاح");
        } catch (error) {
          console.error("خطأ في حفظ البيانات الثابتة:", error);
        }
      }

      // تحميل بيانات الطلاب من Firebase
      async function loadStudentList() {
        if (!currentUser) return;
        
        try {
          const snapshot = await db.collection('teachers').doc(currentUser.uid).collection('students').get();
          students.length = 0;
          studentData = {}; // إعادة تهيئة بيانات الطلاب
          
          snapshot.forEach(doc => {
            students.push(doc.id);
            studentData[doc.id] = doc.data();
          });

          // تحميل البيانات الثابتة لكل طالب
          await loadStudentStaticData();
          
          createStudentList();
          updateDashboard();
          
          // اختيار أول طالب إذا كان هناك طلاب
          if (students.length > 0) {
            const firstStudent = document.querySelector('.student-list li');
            if (firstStudent) {
              selectStudent(students[0], firstStudent);
            }
          }
          
        } catch (error) {
          firebaseStatus.textContent = "خطأ في تحميل البيانات: " + error.message;
          firebaseStatus.style.background = "rgba(231, 76, 60, 0.7)";
          console.error("Firebase load error:", error);
        }
      }

      // تحميل البيانات الثابتة للطلاب
      async function loadStudentStaticData() {
        if (!currentUser) return;
        
        try {
          const snapshot = await db.collection('teachers').doc(currentUser.uid).collection('studentStaticData').get();
          
          snapshot.forEach(doc => {
            const data = doc.data();
            const studentName = doc.id;
            
            if (data.password) {
              studentPasswords[studentName] = data.password;
            }
            
            if (data.memorizedParts && data.memorizedParts.length > 0) {
              memorizedParts[studentName] = data.memorizedParts;
            }
            
            if (data.curriculum) {
              studentCurriculum[studentName] = data.curriculum;
            }
            
            if (data.notes) {
              teacherNotes[studentName] = data.notes;
            }
          });
          
          console.log("تم تحميل البيانات الثابتة بنجاح");
        } catch (error) {
          console.error("خطأ في تحميل البيانات الثابتة:", error);
        }
      }

      // حذف بيانات طالب من Firebase
      async function deleteStudentData(studentName) {
        if (!currentUser) return;
        
        try {
          // حذف بيانات التقييم فقط (مع الاحتفاظ بالبيانات الثابتة)
          await db.collection('teachers').doc(currentUser.uid).collection('students').doc(studentName).delete();
          await db.collection('teachers').doc('public').collection('students').doc(studentName).delete();
          
          firebaseStatus.textContent = "تم حذف بيانات التقييم بنجاح";
          firebaseStatus.style.background = "rgba(39, 174, 96, 0.7)";
        } catch (error) {
          firebaseStatus.textContent = "خطأ في حذف البيانات: " + error.message;
          firebaseStatus.style.background = "rgba(231, 76, 60, 0.7)";
          console.error("Firebase delete error:", error);
        }
      }

      // مسح جميع البيانات من Firebase
      async function clearAllData() {
        if (!currentUser) return;
        
        try {
          // حذف بيانات التقييم فقط (مع الاحتفاظ بالبيانات الثابتة)
          const snapshot = await db.collection('teachers').doc(currentUser.uid).collection('students').get();
          const batch = db.batch();
          snapshot.forEach(doc => {
            batch.delete(doc.ref);
          });
          await batch.commit();
          
          // حذف بيانات التقييم لأولياء الأمور
          const publicSnapshot = await db.collection('teachers').doc('public').collection('students').get();
          const publicBatch = db.batch();
          publicSnapshot.forEach(doc => {
            publicBatch.delete(doc.ref);
          });
          await publicBatch.commit();
          
          firebaseStatus.textContent = "تم مسح جميع بيانات التقييم بنجاح";
          firebaseStatus.style.background = "rgba(39, 174, 96, 0.7)";
        } catch (error) {
          firebaseStatus.textContent = "خطأ في مسح البيانات: " + error.message;
          firebaseStatus.style.background = "rgba(231, 76, 60, 0.7)";
          console.error("Firebase clear error:", error);
        }
      }

      // إضافة طالب جديد
      document.getElementById('addStudentBtn').addEventListener('click', () => {
        document.getElementById('studentPrompt').style.display = 'block';
      });

      document.getElementById('confirmAddStudent').addEventListener('click', async () => {
        const name = document.getElementById('newStudentName').value.trim();
        if (!name) return alert('يرجى إدخال اسم الطالب');
        if (!currentUser) return alert('الرجاء تسجيل الدخول أولاً');

        try {
          // إضافة الطالب إلى Firebase
          await db.collection('teachers').doc(currentUser.uid).collection('students').doc(name).set({
            name: name,
            createdAt: firebase.firestore.FieldValue.serverTimestamp()
          });
          
          // إضافة الطالب إلى القائمة العامة لأولياء الأمور
          await db.collection('teachers').doc('public').collection('students').doc(name).set({
            name: name,
            createdAt: firebase.firestore.FieldValue.serverTimestamp()
          });
          
          // إنشاء سجل للبيانات الثابتة
          await db.collection('teachers').doc(currentUser.uid).collection('studentStaticData').doc(name).set({
            password: '',
            memorizedParts: [],
            curriculum: '',
            notes: '',
            createdAt: firebase.firestore.FieldValue.serverTimestamp()
          });
          
          // إضافة سجل البيانات الثابتة لأولياء الأمور
          await db.collection('teachers').doc('public').collection('studentStaticData').doc(name).set({
            password: '',
            memorizedParts: [],
            curriculum: '',
            notes: '',
            createdAt: firebase.firestore.FieldValue.serverTimestamp()
          });
          
          // إضافة الطالب إلى القائمة المحلية
          students.push(name);
          studentPasswords[name] = '';
          memorizedParts[name] = [];
          studentCurriculum[name] = '';
          teacherNotes[name] = '';
          
          createStudentList();
          
          // إخفاء النموذج ومسح الحقل
          document.getElementById('studentPrompt').style.display = 'none';
          document.getElementById('newStudentName').value = '';
          
          firebaseStatus.textContent = "تمت إضافة الطالب بنجاح";
          firebaseStatus.style.background = "rgba(39, 174, 96, 0.7)";
        } catch (error) {
          console.error("خطأ في إضافة الطالب:", error);
          firebaseStatus.textContent = "خطأ في إضافة الطالب: " + error.message;
          firebaseStatus.style.background = "rgba(231, 76, 60, 0.7)";
        }
      });

      // إضافة وظيفة إخفاء/إظهار الأقسام
      document.querySelectorAll('.section-header .toggle-arrow').forEach(arrow => {
        arrow.addEventListener('click', function() {
          const section = this.closest('.form-group');
          const content = section.querySelector('.form-grid');
          const buttons = section.querySelector('.add-remove-buttons');
          
          if (content) {
            this.classList.toggle('collapsed');
            section.classList.toggle('collapsed-section');
          }
        });
      });

      // بدء تهيئة Firebase
      initializeFirebase();
    });
  </script>
</body>
</html>